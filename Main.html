<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title data-translate="pageTitle">Ù†Ø¸Ø§Ù… Ø§Ù„ÙÙˆØ§ØªÙŠØ± ÙˆØ³Ù†Ø¯Ø§Øª Ø§Ù„ØªØ­ØµÙŠÙ„</title>
<script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
  :root{
    --accent:#0a6efd; --muted:#666; --card:#ffffff; --bg:#f4f6fb; --paper-margin:12mm;
    --danger: #dc3545; --warning: #ffc107; --success: #198754; --secondary: #374151; --info: #0dcaf0;
  }
  *{box-sizing:border-box}
  body{font-family: "Segoe UI", Tahoma, Arial, Helvetica, sans-serif; margin:0; background:var(--bg); color:#111;}
  .wrap{max-width:1140px;margin:18px auto;padding:18px;}
  .card{background:var(--card);border-radius:10px;box-shadow:0 8px 30px rgba(10,20,40,0.06);padding:16px}
  .form-section{border-bottom:1px solid #e5e7eb;padding-bottom:12px;margin-bottom:12px}
  h1,h2,h3{margin:0 0 10px;color:var(--accent)}
  h1{font-size:20px;text-align:center;} h2{font-size:16px;color:#333} h3{font-size:15px;color:var(--muted); margin-top:16px;}
  .row{display:flex;gap:12px;flex-wrap:wrap}
  .col{flex:1 1 220px;min-width:180px}
  label{display:block;font-weight:600;margin-bottom:6px;font-size:14px;}
  input, select, textarea {width:100%;padding:8px;border:1px solid #d8dbe0;border-radius:6px;font-size:14px; background: #fff;}
  .small{font-size:13px;color:var(--muted)}
  .items-table, .log-table {width:100%;border-collapse:collapse;margin-top:12px; font-size: 14px;}
  .items-table th,.items-table td, .log-table th, .log-table td {border:1px solid #e5e7eb;padding:8px;text-align:center; vertical-align: middle;}
  .items-table th, .log-table th {background:#fbfdff;font-weight:700}
  .btn{display:inline-block;padding:8px 12px;border-radius:8px;border:none;cursor:pointer;background:var(--accent);color:#fff;font-weight:700; font-size: 14px; margin: 2px;}
  .btn.info{background: var(--info); color: #000;} .btn.secondary{background:var(--secondary)} .btn.success{background:var(--success)}
  .btn.danger{background:var(--danger)} .btn.warning{background:var(--warning); color: #111;}
  .btn.small-action{padding: 4px 8px; font-size: 12px;}
  .actions{display:flex;gap:10px;flex-wrap:wrap;margin-bottom: 12px; justify-content: center; align-items: center;}
  .customer-balance-display { font-size: 12px; font-weight: bold; color: var(--accent); margin: 0 8px; white-space: nowrap;}
  
  .preview, .statement-preview {display:none; margin-top:18px;padding:20px;border-radius:8px;background:#fff;border:1px solid #eef2ff}
  
  .tabs-nav, .sub-tabs-nav { display: flex; border-bottom: 2px solid #e5e7eb; margin-bottom: 16px; flex-wrap: wrap;}
  .tab-btn, .sub-tab-btn { padding: 10px 20px; cursor: pointer; border: none; background: transparent; font-size: 16px; font-weight: 600; color: var(--muted); border-bottom: 2px solid transparent; margin-bottom: -2px; }
  .tab-btn.active, .sub-tab-btn.active { color: var(--accent); border-bottom-color: var(--accent); }
  .tab-content, .sub-tab-content { display: none; }
  .tab-content.active, .sub-tab-content.active { display: block; animation: fadeIn 0.5s; }
  @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
  .header-controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; flex-wrap: wrap; gap: 10px;}
  .header-buttons { display: flex; gap: 8px; align-items: center; }
  
  .preview-client-details .detail-row { display: flex; margin-bottom: 4px; font-size: 14px;}
  .preview-client-details .detail-label { font-weight: bold; min-width: 120px; }
  body[dir="ltr"] .preview-client-details .detail-label { min-width: 150px; }
  .qr-block{text-align:center}
  #qrContainer { width: 140px; height: 140px; margin: auto; padding: 4px; background: white; border: 1px solid #eee; }
  #qrContainer canvas, #qrContainer img { display: block; width: 100% !important; height: 100% !important; }

  /* Improved Invoice Preview Design */
  .invoice-preview .inv-header { display: flex; justify-content: space-between; align-items: flex-start; }
  .invoice-preview .seller-block { text-align: right; }
  body[dir="ltr"] .invoice-preview .seller-block { text-align: left; }
  .invoice-preview .seller-block h2 { font-size: 22px; color: #000; margin-bottom: 8px;}
  .invoice-preview .invoice-title { text-align: center; margin: 20px 0; font-size: 24px; color: #333; text-decoration: underline;}

  /* --- NEW: Responsive CSS for Mobile --- */
  @media (max-width: 768px) {
    .log-table .actions {
      flex-direction: column; /* Stack buttons vertically */
      gap: 5px; /* Reduce gap between buttons */
    }
    .log-table .btn.small-action {
      width: 90%; /* Make buttons take more width */
      font-size: 11px;
    }
    .log-table td, .log-table th {
      padding: 6px 4px; /* Reduce padding in cells */
    }
     .header-controls {
        flex-direction: column;
        align-items: flex-start;
    }
  }

  @media print{
    body{background:white; color:black;}
    .wrap, .card {box-shadow:none;max-width:100%;margin:0;padding:0;border-radius:0;}
    .no-print {display:none !important}
    .preview, .statement-preview { display: none !important; border:none;margin:0;padding:0;border-radius:0;}
    body.printing-invoice .invoice-preview { display: block !important; }
    body.printing-receipt .receipt-preview { display: block !important; }
    body.printing-statement .statement-preview { display: block !important; }
    @page { size: A4; margin: var(--paper-margin); }
  }
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <div class="no-print">
      <div class="header-controls">
        <h1 data-translate="pageTitle" style="text-align: initial;">Ù†Ø¸Ø§Ù… Ø§Ù„ÙÙˆØ§ØªÙŠØ± ÙˆØ§Ù„Ø³Ù†Ø¯Ø§Øª</h1>
        <div class="header-buttons">
          <span id="welcomeUser" style="font-weight: bold; margin: 0 10px; color: var(--muted); font-size: 14px;"></span>
          <button class="btn secondary" id="langToggleBtn">English</button>
          <button class="btn danger" id="logoutBtn" data-translate="logoutBtn">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
        </div>
      </div>

      <div class="tabs-nav">
        <button class="tab-btn active" data-tab="invoiceTab" data-translate="invoiceTab">ÙØ§ØªÙˆØ±Ø© Ø¶Ø±ÙŠØ¨ÙŠØ©</button>
        <button class="tab-btn" data-tab="receiptTab" data-translate="receiptTab">Ø³Ù†Ø¯ ØªØ­ØµÙŠÙ„</button>
        <button class="tab-btn" data-tab="itemsTab" data-translate="itemsTab">Ø§Ù„Ø£ØµÙ†Ø§Ù</button>
        <button class="tab-btn" data-tab="customersTab" data-translate="customersTab">Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</button>
        <button class="tab-btn" data-tab="settingsTab" data-translate="settingsTab">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆØ§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
      </div>

      <!-- Main Invoice Tab -->
      <div id="invoiceTab" class="tab-content active">
        <div class="sub-tabs-nav">
          <button class="sub-tab-btn active" data-tab="createInvoice" data-parent="invoiceTab" data-translate="createInvoiceSubTab">Ø¥Ù†Ø´Ø§Ø¡ ÙØ§ØªÙˆØ±Ø©</button>
          <button class="sub-tab-btn" data-tab="invoiceLog" data-parent="invoiceTab" data-translate="invoiceLogSubTab">Ø³Ø¬Ù„ Ø§Ù„ÙÙˆØ§ØªÙŠØ±</button>
        </div>
        <div id="createInvoice" class="sub-tab-content active">
          <div class="actions">
            <button class="btn" id="newInvoiceBtn" data-translate="newInvoiceBtn">â• Ø¬Ø¯ÙŠØ¯</button>
            <button class="btn success" id="generateBtn" data-translate="generateBtn">ğŸ’¾ Ø­ÙØ¸</button>
            <button class="btn secondary" id="printInvoiceBtn" data-translate="printBtn">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button>
          </div>
          <div class="form-section">
            <h2 data-translate="invoiceAndCustomerData">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙØ§ØªÙˆØ±Ø© ÙˆØ§Ù„Ø¹Ù…ÙŠÙ„</h2>
            <div class="row">
              <div class="col"><label for="invoiceNumber" data-translate="invoiceNumber">Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©</label><input id="invoiceNumber" type="text"></div>
              <div class="col"><label for="invoiceDate" data-translate="invoiceDate">ØªØ§Ø±ÙŠØ® Ø§Ù„ÙØ§ØªÙˆØ±Ø©</label><input id="invoiceDate" type="datetime-local"></div>
            </div>
            <div class="row" style="margin-top:8px">
              <div class="col" style="display: flex; align-items: center;">
                <div style="flex-grow: 1;">
                  <label for="customerName" data-translate="customerName">Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„</label>
                  <input id="customerName" type="text" list="customersDatalist" data-translate-placeholder="customerNamePlaceholder">
                </div>
                <span id="customerBalanceDisplay" class="customer-balance-display"></span>
              </div>
              <div class="col"><label for="customerTaxNumber" data-translate="customerTaxNumber">Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¶Ø±ÙŠØ¨ÙŠ Ù„Ù„Ø¹Ù…ÙŠÙ„</label><input id="customerTaxNumber" type="text" readonly></div>
            </div>
          </div>
          <div class="form-section">
            <h2 style="margin-bottom:0" data-translate="items">Ø§Ù„Ø£ØµÙ†Ø§Ù</h2>
            <table class="items-table" id="itemsTable">
                <thead><tr><th style="width:40%" data-translate="itemDescription">Ø§Ù„ÙˆØµÙ</th><th data-translate="itemQty">Ø§Ù„ÙƒÙ…ÙŠØ©</th><th data-translate="itemUnitPrice">Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø©</th><th data-translate="itemTotal">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th><th style="width:70px" data-translate="itemAction">Ø¥Ø¬Ø±Ø§Ø¡</th></tr></thead>
                <tbody id="itemsBody"></tbody>
            </table>
            <div style="margin-top:8px" class="controls"><button class="btn" id="addItemBtn" data-translate="addItemBtn">â• Ø¥Ø¶Ø§ÙØ© ØµÙ†Ù</button></div>
            <div class="summary">
              <div style="display:flex;justify-content:space-between;gap:12px;flex-wrap:wrap">
                <div><span data-translate="subTotalLabel">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù‚Ø¨Ù„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©:</span> <strong id="subTotal">0.00</strong> SAR</div>
                <div><span data-translate="vatTotalLabel">Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¶Ø±ÙŠØ¨Ø© (15%):</span> <strong id="vatTotal">0.00</strong> SAR</div>
                <div><span data-translate="grandTotalLabel">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ„ÙŠ:</span> <strong id="grandTotal">0.00</strong> SAR</div>
              </div>
            </div>
          </div>
        </div>
        <div id="invoiceLog" class="sub-tab-content">
           <h2 data-translate="invoiceLogTitle">Ø³Ø¬Ù„ Ø§Ù„ÙÙˆØ§ØªÙŠØ±</h2>
           <table class="log-table" id="invoiceLogTable">
              <thead><tr><th data-translate="logInvoiceNumber">Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©</th><th data-translate="logDate">Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th data-translate="logCustomer">Ø§Ù„Ø¹Ù…ÙŠÙ„</th><th data-translate="logTotal">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th><th data-translate="logActions">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th></tr></thead>
              <tbody id="invoiceLogBody"></tbody>
           </table>
        </div>
      </div>

      <!-- Main Receipt Tab -->
      <div id="receiptTab" class="tab-content">
        <div class="sub-tabs-nav">
          <button class="sub-tab-btn active" data-tab="createReceipt" data-parent="receiptTab" data-translate="createReceiptSubTab">Ø¥Ù†Ø´Ø§Ø¡ Ø³Ù†Ø¯</button>
          <button class="sub-tab-btn" data-tab="receiptLog" data-parent="receiptTab" data-translate="receiptLogSubTab">Ø³Ø¬Ù„ Ø§Ù„Ø³Ù†Ø¯Ø§Øª</button>
        </div>
        <div id="createReceipt" class="sub-tab-content active">
          <h1 data-translate="salesReceiptVoucher">Ø³Ù†Ø¯ ØªØ­ØµÙŠÙ„ Ù…Ø¨ÙŠØ¹Ø§Øª</h1>
           <div class="actions">
            <button class="btn" id="newReceiptBtn" data-translate="newReceiptBtn">â• Ø¬Ø¯ÙŠØ¯</button>
            <button class="btn success" id="saveReceiptBtn" data-translate="saveReceiptBtn">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø³Ù†Ø¯</button>
            <button class="btn secondary" id="printReceiptBtn" data-translate="printReceiptBtn">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø³Ù†Ø¯</button>
          </div>
          <div class="form-section">
            <h2 data-translate="voucherData">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³Ù†Ø¯</h2>
            <div class="row">
                <div class="col"><label for="receiptNumber" data-translate="receiptNumber">Ø±Ù‚Ù… Ø§Ù„Ø³Ù†Ø¯</label><input id="receiptNumber" type="text"></div>
                <div class="col"><label for="receiptDate" data-translate="receiptDate">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø³Ù†Ø¯</label><input id="receiptDate" type="datetime-local"></div>
            </div>
          </div>
          <div class="form-section">
            <h2 data-translate="customerAndCollectionData">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„ ÙˆØ§Ù„ØªØ­ØµÙŠÙ„</h2>
             <div class="row">
                <div class="col" style="display: flex; align-items: center;">
                  <div style="flex-grow: 1;">
                    <label for="receiptCustomerName" data-translate="receiptCustomerName">Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„</label>
                    <input id="receiptCustomerName" type="text" list="customersDatalist" data-translate-placeholder="receiptCustomerNamePlaceholder">
                  </div>
                  <span id="receiptCustomerBalanceDisplay" class="customer-balance-display"></span>
                </div>
                <div class="col"><label for="amountReceived" data-translate="amountReceived">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø³ØªÙ„Ù…</label><input id="amountReceived" type="number" min="0" step="any" placeholder="0.00"></div>
             </div>
             <div class="row" style="margin-top:8px">
                <div class="col"><label for="paymentMethod" data-translate="paymentMethod">Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</label>
                    <select id="paymentMethod">
                        <option value="Cash" data-translate="paymentCash">Ù†Ù‚Ø¯ÙŠ</option>
                        <option value="Bank Transfer" data-translate="paymentBank">ØªØ­ÙˆÙŠÙ„ Ø¨Ù†ÙƒÙŠ</option>
                        <option value="Credit Card" data-translate="paymentCard">Ø¨Ø·Ø§Ù‚Ø© Ø§Ø¦ØªÙ…Ø§Ù†</option>
                    </select>
                </div>
             </div>
          </div>
          <div class="form-section">
            <h2 data-translate="description">Ø§Ù„ÙˆØµÙ</h2>
            <div class="row"><div class="col"><label for="receiptDescription" data-translate="receiptDescriptionLabel">ÙˆØµÙ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ØªØ­ØµÙŠÙ„</label><textarea id="receiptDescription" data-translate-placeholder="receiptDescriptionPlaceholder"></textarea></div></div>
          </div>
        </div>
        <div id="receiptLog" class="sub-tab-content">
          <h2 data-translate="receiptLogTitle">Ø³Ø¬Ù„ Ø³Ù†Ø¯Ø§Øª Ø§Ù„ØªØ­ØµÙŠÙ„</h2>
          <table class="log-table" id="receiptLogTable">
              <thead><tr><th data-translate="logReceiptNumber">Ø±Ù‚Ù… Ø§Ù„Ø³Ù†Ø¯</th><th data-translate="logDate">Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th data-translate="logCustomer">Ø§Ù„Ø¹Ù…ÙŠÙ„</th><th data-translate="logAmount">Ø§Ù„Ù…Ø¨Ù„Øº</th><th data-translate="logActions">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th></tr></thead>
              <tbody id="receiptLogBody"></tbody>
          </table>
        </div>
      </div>

      <!-- Items Management Tab -->
      <div id="itemsTab" class="tab-content">
        <div class="sub-tabs-nav">
            <button class="sub-tab-btn active" data-tab="createItem" data-parent="itemsTab" data-translate="createItemSubTab">Ø¥Ù†Ø´Ø§Ø¡ ØµÙ†Ù</button>
            <button class="sub-tab-btn" data-tab="itemLog" data-parent="itemsTab" data-translate="itemLogSubTab">Ø³Ø¬Ù„ Ø§Ù„Ø£ØµÙ†Ø§Ù</button>
        </div>
        <div id="createItem" class="sub-tab-content active">
            <h2 data-translate="addNewItem">Ø¥Ø¶Ø§ÙØ©/ØªØ¹Ø¯ÙŠÙ„ ØµÙ†Ù</h2>
            <div class="row">
                <div class="col"><label for="itemName" data-translate="itemName">Ø§Ø³Ù…/ÙˆØµÙ Ø§Ù„ØµÙ†Ù</label><input id="itemName" type="text"></div>
                <div class="col"><label for="itemPrice" data-translate="itemPrice">Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø©</label><input id="itemPrice" type="number" min="0" step="any"></div>
            </div>
            <div class="actions" style="margin-top: 16px;">
                <button class="btn success" id="saveItemBtn" data-translate="saveItemBtn">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØµÙ†Ù</button>
                <button class="btn secondary" id="clearItemFormBtn" data-translate="clearFormBtn">â• Ø¬Ø¯ÙŠØ¯</button>
            </div>
        </div>
        <div id="itemLog" class="sub-tab-content">
            <h2 data-translate="savedItems">Ø§Ù„Ø£ØµÙ†Ø§Ù Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©</h2>
            <table class="log-table" id="itemsLogTable">
                <thead><tr><th data-translate="itemName">Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù</th><th data-translate="itemPrice">Ø§Ù„Ø³Ø¹Ø±</th><th data-translate="qtySold">Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø¨Ø§Ø¹Ø©</th><th data-translate="logActions">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th></tr></thead>
                <tbody id="itemsLogBody"></tbody>
            </table>
        </div>
      </div>
      
      <!-- Customers Management Tab -->
      <div id="customersTab" class="tab-content">
        <div class="sub-tabs-nav">
            <button class="sub-tab-btn active" data-tab="createCustomer" data-parent="customersTab" data-translate="createCustomerSubTab">Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ù…ÙŠÙ„</button>
            <button class="sub-tab-btn" data-tab="customerLog" data-parent="customersTab" data-translate="customerLogSubTab">Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</button>
        </div>
        <div id="createCustomer" class="sub-tab-content active">
            <h2 data-translate="addNewCustomer">Ø¥Ø¶Ø§ÙØ©/ØªØ¹Ø¯ÙŠÙ„ Ø¹Ù…ÙŠÙ„</h2>
            <div class="row">
                <div class="col"><label for="custCode" data-translate="customerCode">ÙƒÙˆØ¯ Ø§Ù„Ø¹Ù…ÙŠÙ„</label><input id="custCode" type="text"></div>
                <div class="col"><label for="custName" data-translate="customerName">Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„</label><input id="custName" type="text"></div>
                <div class="col"><label for="custTaxNumber" data-translate="customerTaxNumber">Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¶Ø±ÙŠØ¨ÙŠ</label><input id="custTaxNumber" type="text"></div>
            </div>
             <div class="row" style="margin-top:8px">
                <div class="col"><label for="custCrNumber" data-translate="crNumber">Ø±Ù‚Ù… Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„ØªØ¬Ø§Ø±ÙŠ</label><input id="custCrNumber" type="text"></div>
                <div class="col"><label for="custNationalId" data-translate="nationalId">Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©</label><input id="custNationalId" type="text"></div>
                <div class="col"><label for="custPhone" data-translate="phone">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label><input id="custPhone" type="text"></div>
            </div>
            <h3 data-translate="nationalAddress">Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙˆØ·Ù†ÙŠ</h3>
            <div class="row">
                <div class="col"><label for="custCity" data-translate="city">Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©</label><input id="custCity" type="text"></div>
                <div class="col"><label for="custDistrict" data-translate="district">Ø§Ù„Ø­ÙŠ</label><input id="custDistrict" type="text"></div>
                <div class="col"><label for="custStreet" data-translate="street">Ø§Ù„Ø´Ø§Ø±Ø¹</label><input id="custStreet" type="text"></div>
            </div>
            <div class="row" style="margin-top:8px">
                <div class="col"><label for="custPostalCode" data-translate="postalCode">Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ø¨Ø±ÙŠØ¯ÙŠ</label><input id="custPostalCode" type="text" maxlength="5" oninput="this.value = this.value.replace(/[^0-9]/g, '')"></div>
                <div class="col"><label for="custBuildingNumber" data-translate="buildingNumber">Ø±Ù‚Ù… Ø§Ù„Ù…Ø¨Ù†Ù‰</label><input id="custBuildingNumber" type="text" maxlength="4" oninput="this.value = this.value.replace(/[^0-9]/g, '')"></div>
                <div class="col"><label for="custAdditionalNumber" data-translate="additionalNumber">Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¥Ø¶Ø§ÙÙŠ</label><input id="custAdditionalNumber" type="text" maxlength="4" oninput="this.value = this.value.replace(/[^0-9]/g, '')"></div>
            </div>
            <div class="actions" style="margin-top: 16px;">
                <button class="btn success" id="saveCustomerBtn" data-translate="saveCustomerBtn">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø¹Ù…ÙŠÙ„</button>
                <button class="btn secondary" id="clearCustomerFormBtn" data-translate="clearFormBtn">â• Ø¬Ø¯ÙŠØ¯</button>
            </div>
        </div>
        <div id="customerLog" class="sub-tab-content">
            <h2 data-translate="savedCustomers">Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø§Ù„Ù…Ø­ÙÙˆØ¸ÙˆÙ†</h2>
            <table class="log-table" id="customersLogTable">
                <thead><tr>
                    <th data-translate="customerCode">Ø§Ù„ÙƒÙˆØ¯</th>
                    <th data-translate="customerName">Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„</th>
                    <th data-translate="phone">Ø§Ù„Ù‡Ø§ØªÙ</th>
                    <th data-translate="balance">Ø§Ù„Ø±ØµÙŠØ¯</th>
                    <th data-translate="logActions">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                </tr></thead>
                <tbody id="customersLogBody"></tbody>
            </table>
        </div>
      </div>
      
      <!-- Settings Tab -->
      <div id="settingsTab" class="tab-content">
        <h1 data-translate="settingsTab">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆØ§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h1>
        <div class="form-section">
            <h2 data-translate="companySection">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ø±ÙƒØ©</h2>
            <p class="small" data-translate="companySectionHint">Ù‡Ø°Ù‡ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø³ØªØ¸Ù‡Ø± ÙÙŠ Ø£Ø¹Ù„Ù‰ Ø§Ù„ÙÙˆØ§ØªÙŠØ± ÙˆØ§Ù„Ø³Ù†Ø¯Ø§Øª Ø§Ù„Ù…Ø·Ø¨ÙˆØ¹Ø©.</p>
            <div class="row">
                <div class="col"><label for="settingSellerName" data-translate="sellerName">Ø§Ø³Ù… Ø§Ù„Ø´Ø±ÙƒØ©</label><input id="settingSellerName" type="text"></div>
                <div class="col"><label for="settingSellerTaxNum" data-translate="sellerTaxNumber">Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¶Ø±ÙŠØ¨ÙŠ</label><input id="settingSellerTaxNum" type="text"></div>
            </div>
            <div class="row" style="margin-top:8px">
                <div class="col"><label for="settingSellerPhone" data-translate="phone">Ø§Ù„Ù‡Ø§ØªÙ</label><input id="settingSellerPhone" type="text"></div>
                <div class="col"><label for="settingSellerAddress" data-translate="sellerAddress">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</label><input id="settingSellerAddress" type="text"></div>
            </div>
            <div class="actions" style="margin-top: 16px;">
                <button class="btn success" id="saveSettingsBtn" data-translate="saveSettingsBtn">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
            </div>
        </div>
        <div class="form-section">
            <h2 data-translate="databaseManagement">Ø¥Ø¯Ø§Ø±Ø© Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h2>
            <p class="small" data-translate="databaseManagementHint">ÙŠÙ…ÙƒÙ†Ùƒ Ø£Ø®Ø° Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ù…Ù† ÙƒÙ„ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ ÙÙŠ Ù…Ù„ÙØŒ Ø£Ùˆ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ù†Ø³Ø®Ø© Ø³Ø§Ø¨Ù‚Ø©. Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØªØ­ÙØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ ÙÙŠ Ø§Ù„Ù…ØªØµÙØ­.</p>
            <div class="actions">
                <button class="btn" id="exportAllBtn" data-translate="exportAllBtn">ğŸ’¾ ØªØµØ¯ÙŠØ± Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©</button>
                <div>
                    <label for="importAllFile" class="btn secondary" data-translate="importAllBtn">ğŸ“‚ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ù…Ù† Ù…Ù„Ù</label>
                    <input type="file" id="importAllFile" accept=".xlsx, .xls" style="display:none;">
                </div>
                <button class="btn danger" id="clearAllDataBtn" data-translate="clearAllDataBtn">ğŸ—‘ï¸ Ù…Ø³Ø­ ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Ø®Ø·Ø±)</button>
            </div>
        </div>
      </div>
      
      <!-- Single, global datalists to prevent duplicate ID errors -->
      <datalist id="customersDatalist"></datalist>
      <datalist id="itemsDatalist"></datalist>
    </div>

    <!-- Preview Areas -->
    <div class="preview invoice-preview" id="invoicePreview">
        <div class="inv-header">
            <div class="seller-block">
                <h2 id="previewSellerName"></h2>
                <div id="previewSellerInfo" class="small"></div>
            </div>
            <div class="qr-block"><div id="qrContainer"></div><div class="small" style="margin-top:6px" data-translate="qrScan">Ø§Ù…Ø³Ø­ QR Ù„Ù„ØªØ­Ù‚Ù‚</div></div>
        </div>
        <h1 class="invoice-title" id="invoiceTitle"></h1>
        <div id="previewClient" style="margin-top:20px; background: #f9f9f9; padding: 12px; border-radius: 6px;" class="preview-client-details"></div>
        <div style="margin-top:20px; border-top:1px solid #eee; padding-top:10px; display:flex; justify-content: space-between;">
            <div><div class="small" data-translate="previewInvoiceNo">ÙØ§ØªÙˆØ±Ø© Ø±Ù‚Ù…:</div><div id="previewInvoiceNo" style="font-weight:700"></div></div>
            <div><div class="small" data-translate="previewDate">Ø§Ù„ØªØ§Ø±ÙŠØ®:</div><div id="previewDate" style="font-weight:700"></div></div>
        </div>
        <div id="previewItems" style="margin-top:20px"></div>
        <div id="previewTotals" style="margin-top:20px; padding-top:10px; border-top: 1px solid #eee;"></div>
        <footer class="small" style="text-align:center; margin-top: 20px;" data-translate="thankYou">Ø´ÙƒØ±Ø§ Ù„ÙƒÙ…</footer>
    </div>
    <div class="preview receipt-preview" id="receiptPreview">
        <div class="receipt-header" style="text-align:center; margin-bottom: 20px;">
            <h2 id="receiptPreviewSellerName"></h2>
            <div class="small" id="receiptPreviewSellerInfo"></div>
        </div>
        <h1 style="text-align:center; font-size: 1.2em; border-bottom: 1px solid #333; padding-bottom: 5px; margin-bottom: 15px;" data-translate="receiptVoucherTitle">Ø³Ù†Ø¯ ØªØ­ØµÙŠÙ„</h1>
        <table style="width:100%; border-collapse:collapse; font-size: 1em;">
            <tbody style="text-align: right;">
                <tr><td style="font-weight:bold; padding:4px;" data-translate="previewReceiptNumber">Ø±Ù‚Ù… Ø§Ù„Ø³Ù†Ø¯:</td><td id="receiptPreviewNumber" style="padding:4px;"></td></tr>
                <tr><td style="font-weight:bold; padding:4px;" data-translate="previewDate">Ø§Ù„ØªØ§Ø±ÙŠØ®:</td><td id="receiptPreviewDate" style="padding:4px;"></td></tr>
                <tr><td style="font-weight:bold; padding:4px;" data-translate="previewReceivedFrom">Ø§Ø³ØªÙ„Ù…Ù†Ø§ Ù…Ù† Ø§Ù„Ø³ÙŠØ¯/Ø§Ù„Ø³Ø§Ø¯Ø©:</td><td id="receiptPreviewCustomer" style="padding:4px;"></td></tr>
                <tr><td style="font-weight:bold; padding:4px;" data-translate="previewAmount">Ù…Ø¨Ù„Øº ÙˆÙ‚Ø¯Ø±Ù‡:</td><td id="receiptPreviewAmount" style="padding:4px;"></td></tr>
                <tr><td style="font-weight:bold; padding:4px;" data-translate="previewFor">ÙˆØ°Ù„Ùƒ Ø¹Ù†:</td><td id="receiptPreviewDesc" style="padding:4px;"></td></tr>
                <tr><td style="font-weight:bold; padding:4px;" data-translate="previewPaymentMethod">Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹:</td><td id="receiptPreviewPayment" style="padding:4px;"></td></tr>
            </tbody>
        </table>
        <div style="margin-top: 40px; display: flex; justify-content: space-between; font-size: 0.9em;">
            <div><strong data-translate="signatureReceiver">Ø§Ù„Ù…Ø³ØªÙ„Ù…: ....................</strong></div>
            <div><strong data-translate="signatureStamp">Ø§Ù„Ø®ØªÙ…:</strong></div>
        </div>
    </div>
    <div class="statement-preview" id="statementPreview">
        <div class="statement-header" style="text-align:center; margin-bottom: 20px;">
            <h2 id="statementSellerName"></h2>
            <div class="small" id="statementSellerInfo"></div>
            <h1 style="margin-top: 20px;" data-translate="accountStatementTitle">ÙƒØ´Ù Ø­Ø³Ø§Ø¨ Ø¹Ù…ÙŠÙ„</h1>
        </div>
        <div id="statementClientInfo" style="margin-bottom: 20px; padding: 10px; border: 1px solid #eee; border-radius: 6px;"></div>
        <table class="log-table" id="statementTable">
            <thead>
                <tr>
                    <th data-translate="logDate">Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                    <th data-translate="statementTransaction">Ø§Ù„Ø­Ø±ÙƒØ©</th>
                    <th data-translate="statementDebit">Ù…Ø¯ÙŠÙ†</th>
                    <th data-translate="statementCredit">Ø¯Ø§Ø¦Ù†</th>
                    <th data-translate="balance">Ø§Ù„Ø±ØµÙŠØ¯</th>
                </tr>
            </thead>
            <tbody id="statementTableBody"></tbody>
        </table>
        <div id="statementSummary" style="margin-top: 20px; padding-top: 10px; border-top: 1px solid #eee; text-align: left;"></div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    
    // --- NEW: Authentication Check ---
    const loggedInUser = sessionStorage.getItem('loggedInUser');
    if (!loggedInUser) {
        // IMPORTANT: Make sure you have a 'login.html' file in the same directory
        window.location.href = 'login.html'; 
        return; // Stop script execution
    }

    // --- DBs and State ---
    let invoicesDB, receiptsDB, itemsDB, customersDB, sellerInfo;
    let currentLang = 'ar';
    let editingInvoiceId = null, editingReceiptId = null, editingItemId = null, editingCustomerId = null;
    const defaultSellerInfo = { name: "Ø´Ø±ÙƒØªÙŠ", taxNumber: "123456789012345", address: "Ø§Ù„Ø±ÙŠØ§Ø¶ØŒ Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ©", phone: "0501234567" };

    // --- Helper Functions ---
    const $ = id => document.getElementById(id);
    const toLocalDateTime = (date = new Date()) => new Date(date.getTime() - (date.getTimezoneOffset() * 60000)).toISOString().slice(0, 16);
    const formatDate = (dateStr) => {
        if (!dateStr) return '';
        const date = new Date(dateStr);
        return `${String(date.getDate()).padStart(2, '0')}-${String(date.getMonth() + 1).padStart(2, '0')}-${date.getFullYear()}`;
    };
    const escapeHTML = s => (s || '').toString().replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m]);

    // --- MODIFIED: User-Specific Local Storage Functions ---
    function saveAllDataToLocalStorage() {
        try {
            const dataToSave = { invoicesDB, receiptsDB, itemsDB, customersDB, sellerInfo };
            // Save data under a user-specific key
            localStorage.setItem(`accountingData_${loggedInUser}`, JSON.stringify(dataToSave));
        } catch (e) {
            console.error("Error saving to localStorage", e);
            alert("Could not save data automatically. Your browser might be in private mode or storage is full.");
        }
    }

    function loadAllDataFromLocalStorage() {
        // Load data from the user-specific key
        const savedData = localStorage.getItem(`accountingData_${loggedInUser}`);
        if (savedData) {
            try {
                const data = JSON.parse(savedData);
                invoicesDB = data.invoicesDB || [];
                receiptsDB = data.receiptsDB || [];
                itemsDB = data.itemsDB || [];
                customersDB = data.customersDB || [];
                sellerInfo = data.sellerInfo || defaultSellerInfo;
            } catch (e) {
                console.error("Error parsing data from localStorage", e);
                initializeAppWithDefaults();
            }
        } else {
            // If no data for this user, start with fresh defaults
            initializeAppWithDefaults();
        }
    }

    function initializeAppWithDefaults(){
        invoicesDB = []; receiptsDB = []; itemsDB = []; customersDB = [];
        sellerInfo = defaultSellerInfo;
    }

    // --- Translations Object (with added logout and modified prompts) ---
    const translations = {
      en: {
        pageTitle: "Invoicing & Collection System", logoutBtn: "Logout", invoiceTab: "Tax Invoice", receiptTab: "Receipt Voucher", itemsTab: "Items", customersTab: "Customers", settingsTab: "Data & Settings", createInvoiceSubTab: "Create Invoice", invoiceLogSubTab: "Invoice Log", createCustomerSubTab: "Create Customer", customerLogSubTab: "Customer Log", createItemSubTab: "Create Item", itemLogSubTab: "Item Log", companySection: "Company Information", sellerName: "Company Name", sellerTaxNumber: "Tax Number", sellerPhone: "Company Phone", sellerAddress: "Company Address", companySectionHint: "This information will appear on printed invoices and receipts.", invoiceAndCustomerData: "Invoice & Customer Data", invoiceNumber: "Invoice Number", invoiceDate: "Invoice Date", customerName: "Customer Name", customerNamePlaceholder: "Select or type customer name", customerTaxNumber: "Customer Tax Number", items: "Items", itemDescription: "Description", itemQty: "Qty", itemUnitPrice: "Unit Price", itemTotal: "Total", itemAction: "Action", addItemBtn: "â• Add Item", subTotalLabel: "Subtotal:", vatTotalLabel: "VAT (15%):", grandTotalLabel: "Grand Total:", newInvoiceBtn: "â• New", generateBtn: "ğŸ’¾ Save", printBtn: "ğŸ–¨ï¸ Print", invoiceLogTitle: "Invoices Log", logInvoiceNumber: "Invoice #", logDate: "Date", logCustomer: "Customer", logTotal: "Total", createReceiptSubTab: "Create Receipt", receiptLogSubTab: "Receipt Log", salesReceiptVoucher: "Sales Receipt Voucher", voucherData: "Voucher Data", receiptNumber: "Voucher No.", receiptDate: "Voucher Date", customerAndCollectionData: "Customer & Collection Data", receiptCustomerName: "Customer Name", receiptCustomerNamePlaceholder: "Select customer", amountReceived: "Amount Received", paymentMethod: "Payment Method", paymentCash: "Cash", paymentBank: "Bank Transfer", paymentCard: "Credit Card", description: "Description", receiptDescriptionLabel: "Collection Description", receiptDescriptionPlaceholder: "e.g., Payment for invoice #INV-0001", newReceiptBtn: "â• New", saveReceiptBtn: "ğŸ’¾ Save Voucher", printReceiptBtn: "ğŸ–¨ï¸ Print Voucher", receiptLogTitle: "Receipts Log", logReceiptNumber: "Voucher #", logAmount: "Amount", qrScan: "Scan QR for verification", previewInvoiceNo: "Invoice No:", previewDate: "Date:", thankYou: "Thank you", receiptVoucherTitle: "Receipt Voucher", previewReceiptNumber: "Voucher No.:", previewReceivedFrom: "Received from Mr./M/s:", previewAmount: "The sum of:", previewFor: "In settlement of:", previewPaymentMethod: "Payment Method:", signatureReceiver: "Receiver: ....................", signatureStamp: "Stamp:", invoiceTo: "Bill To:",
        itemsManagement: "Items Management", addNewItem: "Add/Edit Item", itemName: "Item Name/Description", itemPrice: "Unit Price", saveItemBtn: "ğŸ’¾ Save Item", updateItemBtn: "ğŸ’¾ Update Item", savedItems: "Saved Items", qtySold: "Qty Sold", customersManagement: "Customers Management", addNewCustomer: "Add/Edit Customer", logActions: "Actions", editBtn: "Edit", deleteBtn: "Delete", confirmDelete: "Are you sure you want to delete this record? This action cannot be undone.", updateBtnText: "ğŸ’¾ Update Invoice", updateReceiptBtnText: "ğŸ’¾ Update Voucher",
        customerCode: "Customer Code", balance: "Balance", printStatement: "Statement", crNumber: "C.R. Number", nationalId: "National ID", phone: "Phone", nationalAddress: "National Address", city: "City", district: "District", street: "Street", postalCode: "Postal Code", buildingNumber: "Building No.", additionalNumber: "Additional No.", saveCustomerBtn: "ğŸ’¾ Save Customer", updateCustomerBtn: "ğŸ’¾ Update Customer", clearFormBtn: "â• New", accountStatementTitle: "Customer Account Statement", statementTransaction: "Transaction", statementDebit: "Debit", statementCredit: "Credit", balanceDue: "Balance Due:", closingBalance: "Closing Balance", savedCustomers: "Saved Customers",
        saveSettingsBtn: "ğŸ’¾ Save Settings", databaseManagement: "Database Management", databaseManagementHint: "You can export a backup of your data, or restore from a file. Data is saved automatically in your browser.", exportAllBtn: "ğŸ’¾ Export Backup", importAllBtn: "ğŸ“‚ Restore from File", importSuccess: "Database restored successfully!", importError: "Failed to restore database. Please check the file format.", simplifiedTaxInvoice: "Simplified Tax Invoice",
        clearAllDataBtn: "ğŸ—‘ï¸ Clear All Data (Danger)", confirmClearAll: "ARE YOU SURE? All data for this user will be permanently deleted. This action cannot be undone."
      },
      ar: {
        pageTitle: "Ù†Ø¸Ø§Ù… Ø§Ù„ÙÙˆØ§ØªÙŠØ± ÙˆØ§Ù„Ø³Ù†Ø¯Ø§Øª", logoutBtn: "ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬", invoiceTab: "ÙØ§ØªÙˆØ±Ø© Ø¶Ø±ÙŠØ¨ÙŠØ©", receiptTab: "Ø³Ù†Ø¯ ØªØ­ØµÙŠÙ„", itemsTab: "Ø§Ù„Ø£ØµÙ†Ø§Ù", customersTab: "Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡", settingsTab: "Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆØ§Ù„Ø¨ÙŠØ§Ù†Ø§Øª", createInvoiceSubTab: "Ø¥Ù†Ø´Ø§Ø¡ ÙØ§ØªÙˆØ±Ø©", invoiceLogSubTab: "Ø³Ø¬Ù„ Ø§Ù„ÙÙˆØ§ØªÙŠØ±", createCustomerSubTab: "Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ù…ÙŠÙ„", customerLogSubTab: "Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡", createItemSubTab: "Ø¥Ù†Ø´Ø§Ø¡ ØµÙ†Ù", itemLogSubTab: "Ø³Ø¬Ù„ Ø§Ù„Ø£ØµÙ†Ø§Ù", companySection: "Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ø±ÙƒØ©", sellerName: "Ø§Ø³Ù… Ø§Ù„Ø´Ø±ÙƒØ©", sellerTaxNumber: "Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¶Ø±ÙŠØ¨ÙŠ", sellerPhone: "Ù‡Ø§ØªÙ Ø§Ù„Ø´Ø±ÙƒØ©", sellerAddress: "Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø´Ø±ÙƒØ©", companySectionHint: "Ù‡Ø°Ù‡ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø³ØªØ¸Ù‡Ø± ÙÙŠ Ø£Ø¹Ù„Ù‰ Ø§Ù„ÙÙˆØ§ØªÙŠØ± ÙˆØ§Ù„Ø³Ù†Ø¯Ø§Øª Ø§Ù„Ù…Ø·Ø¨ÙˆØ¹Ø©.", invoiceAndCustomerData: "Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙØ§ØªÙˆØ±Ø© ÙˆØ§Ù„Ø¹Ù…ÙŠÙ„", invoiceNumber: "Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©", invoiceDate: "ØªØ§Ø±ÙŠØ® Ø§Ù„ÙØ§ØªÙˆØ±Ø©", customerName: "Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„", customerNamePlaceholder: "Ø§Ø®ØªØ± Ø£Ùˆ Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„", customerTaxNumber: "Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¶Ø±ÙŠØ¨ÙŠ Ù„Ù„Ø¹Ù…ÙŠÙ„", items: "Ø§Ù„Ø£ØµÙ†Ø§Ù", itemDescription: "Ø§Ù„ÙˆØµÙ", itemQty: "Ø§Ù„ÙƒÙ…ÙŠØ©", itemUnitPrice: "Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø©", itemTotal: "Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ", itemAction: "Ø¥Ø¬Ø±Ø§Ø¡", addItemBtn: "â• Ø¥Ø¶Ø§ÙØ© ØµÙ†Ù", subTotalLabel: "Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù‚Ø¨Ù„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©:", vatTotalLabel: "Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¶Ø±ÙŠØ¨Ø© (15%):", grandTotalLabel: "Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ„ÙŠ:", newInvoiceBtn: "â• Ø¬Ø¯ÙŠØ¯", generateBtn: "ğŸ’¾ Ø­ÙØ¸", printBtn: "ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©", invoiceLogTitle: "Ø³Ø¬Ù„ Ø§Ù„ÙÙˆØ§ØªÙŠØ±", logInvoiceNumber: "Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©", logDate: "Ø§Ù„ØªØ§Ø±ÙŠØ®", logCustomer: "Ø§Ù„Ø¹Ù…ÙŠÙ„", logTotal: "Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ", createReceiptSubTab: "Ø¥Ù†Ø´Ø§Ø¡ Ø³Ù†Ø¯", receiptLogSubTab: "Ø³Ø¬Ù„ Ø§Ù„Ø³Ù†Ø¯Ø§Øª", salesReceiptVoucher: "Ø³Ù†Ø¯ ØªØ­ØµÙŠÙ„ Ù…Ø¨ÙŠØ¹Ø§Øª", voucherData: "Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³Ù†Ø¯", receiptNumber: "Ø±Ù‚Ù… Ø§Ù„Ø³Ù†Ø¯", receiptDate: "ØªØ§Ø±ÙŠØ® Ø§Ù„Ø³Ù†Ø¯", customerAndCollectionData: "Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„ ÙˆØ§Ù„ØªØ­ØµÙŠÙ„", receiptCustomerName: "Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„", receiptCustomerNamePlaceholder: "Ø§Ø®ØªØ± Ø§Ù„Ø¹Ù…ÙŠÙ„", amountReceived: "Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø³ØªÙ„Ù…", paymentMethod: "Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹", paymentCash: "Ù†Ù‚Ø¯ÙŠ", paymentBank: "ØªØ­ÙˆÙŠÙ„ Ø¨Ù†ÙƒÙŠ", paymentCard: "Ø¨Ø·Ø§Ù‚Ø© Ø§Ø¦ØªÙ…Ø§Ù†", description: "Ø§Ù„ÙˆØµÙ", receiptDescriptionLabel: "ÙˆØµÙ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ØªØ­ØµÙŠÙ„", receiptDescriptionPlaceholder: "Ù…Ø«Ø§Ù„: Ø¯ÙØ¹Ø© Ù…Ù† ÙØ§ØªÙˆØ±Ø© Ø±Ù‚Ù… INV-0001", newReceiptBtn: "â• Ø¬Ø¯ÙŠØ¯", saveReceiptBtn: "ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø³Ù†Ø¯", printReceiptBtn: "ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø³Ù†Ø¯", receiptLogTitle: "Ø³Ø¬Ù„ Ø³Ù†Ø¯Ø§Øª Ø§Ù„ØªØ­ØµÙŠÙ„", logReceiptNumber: "Ø±Ù‚Ù… Ø§Ù„Ø³Ù†Ø¯", logAmount: "Ø§Ù„Ù…Ø¨Ù„Øº", qrScan: "Ø§Ù…Ø³Ø­ QR Ù„Ù„ØªØ­Ù‚Ù‚", previewInvoiceNo: "ÙØ§ØªÙˆØ±Ø© Ø±Ù‚Ù…:", previewDate: "Ø§Ù„ØªØ§Ø±ÙŠØ®:", thankYou: "Ø´ÙƒØ±Ø§ Ù„ÙƒÙ…", receiptVoucherTitle: "Ø³Ù†Ø¯ ØªØ­ØµÙŠÙ„", previewReceiptNumber: "Ø±Ù‚Ù… Ø§Ù„Ø³Ù†Ø¯:", previewReceivedFrom: "Ø§Ø³ØªÙ„Ù…Ù†Ø§ Ù…Ù† Ø§Ù„Ø³ÙŠØ¯/Ø§Ù„Ø³Ø§Ø¯Ø©:", previewAmount: "Ù…Ø¨Ù„Øº ÙˆÙ‚Ø¯Ø±Ù‡:", previewFor: "ÙˆØ°Ù„Ùƒ Ø¹Ù†:", previewPaymentMethod: "Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹:", signatureReceiver: "Ø§Ù„Ù…Ø³ØªÙ„Ù…: ....................", signatureStamp: "Ø§Ù„Ø®ØªÙ…:", invoiceTo: "ÙØ§ØªÙˆØ±Ø© Ø¥Ù„Ù‰:",
        itemsManagement: "Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£ØµÙ†Ø§Ù", addNewItem: "Ø¥Ø¶Ø§ÙØ©/ØªØ¹Ø¯ÙŠÙ„ ØµÙ†Ù", itemName: "Ø§Ø³Ù…/ÙˆØµÙ Ø§Ù„ØµÙ†Ù", itemPrice: "Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø©", saveItemBtn: "ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØµÙ†Ù", updateItemBtn: "ğŸ’¾ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙ†Ù", savedItems: "Ø§Ù„Ø£ØµÙ†Ø§Ù Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©", qtySold: "Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø¨Ø§Ø¹Ø©", customersManagement: "Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡", addNewCustomer: "Ø¥Ø¶Ø§ÙØ©/ØªØ¹Ø¯ÙŠÙ„ Ø¹Ù…ÙŠÙ„", logActions: "Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª", editBtn: "ØªØ¹Ø¯ÙŠÙ„", deleteBtn: "Ø­Ø°Ù", confirmDelete: "Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø³Ø¬Ù„ØŸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡.", updateBtnText: "ğŸ’¾ ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙØ§ØªÙˆØ±Ø©", updateReceiptBtnText: "ğŸ’¾ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³Ù†Ø¯",
        customerCode: "ÙƒÙˆØ¯ Ø§Ù„Ø¹Ù…ÙŠÙ„", balance: "Ø§Ù„Ø±ØµÙŠØ¯", printStatement: "ÙƒØ´Ù Ø­Ø³Ø§Ø¨", crNumber: "Ø±Ù‚Ù… Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„ØªØ¬Ø§Ø±ÙŠ", nationalId: "Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©", phone: "Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ", nationalAddress: "Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙˆØ·Ù†ÙŠ", city: "Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©", district: "Ø§Ù„Ø­ÙŠ", street: "Ø§Ù„Ø´Ø§Ø±Ø¹", postalCode: "Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ø¨Ø±ÙŠØ¯ÙŠ", buildingNumber: "Ø±Ù‚Ù… Ø§Ù„Ù…Ø¨Ù†Ù‰", additionalNumber: "Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¥Ø¶Ø§ÙÙŠ", saveCustomerBtn: "ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø¹Ù…ÙŠÙ„", updateCustomerBtn: "ğŸ’¾ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù…ÙŠÙ„", clearFormBtn: "â• Ø¬Ø¯ÙŠØ¯", accountStatementTitle: "ÙƒØ´Ù Ø­Ø³Ø§Ø¨ Ø¹Ù…ÙŠÙ„", statementTransaction: "Ø§Ù„Ø­Ø±ÙƒØ©", statementDebit: "Ù…Ø¯ÙŠÙ†", statementCredit: "Ø¯Ø§Ø¦Ù†", balanceDue: "Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù…Ø³ØªØ­Ù‚:", closingBalance: "Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø®ØªØ§Ù…ÙŠ", savedCustomers: "Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø§Ù„Ù…Ø­ÙÙˆØ¸ÙˆÙ†",
        saveSettingsBtn: "ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª", databaseManagement: "Ø¥Ø¯Ø§Ø±Ø© Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª", databaseManagementHint: "ÙŠÙ…ÙƒÙ†Ùƒ Ø£Ø®Ø° Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ù…Ù† ÙƒÙ„ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ ÙÙŠ Ù…Ù„ÙØŒ Ø£Ùˆ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ù†Ø³Ø®Ø© Ø³Ø§Ø¨Ù‚Ø©. Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØªØ­ÙØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ ÙÙŠ Ø§Ù„Ù…ØªØµÙØ­.", exportAllBtn: "ğŸ’¾ ØªØµØ¯ÙŠØ± Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©", importAllBtn: "ğŸ“‚ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ù…Ù† Ù…Ù„Ù", importSuccess: "ØªÙ… Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!", importError: "ÙØ´Ù„ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª. Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ØµÙŠØºØ© Ø§Ù„Ù…Ù„Ù.", simplifiedTaxInvoice: "ÙØ§ØªÙˆØ±Ø© Ø¶Ø±ÙŠØ¨ÙŠØ© Ù…Ø¨Ø³Ø·Ø©",
        clearAllDataBtn: "ğŸ—‘ï¸ Ù…Ø³Ø­ ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Ø®Ø·Ø±)", confirmClearAll: "Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ ØªÙ…Ø§Ù…Ø§Ù‹ØŸ Ø³ÙŠØªÙ… Ø­Ø°Ù ÙƒÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø´ÙƒÙ„ Ù†Ù‡Ø§Ø¦ÙŠ. Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡."
      }
    };
    
    // --- Efficient Language Switcher ---
    function setLanguage(lang) {
        currentLang = lang;
        document.documentElement.lang = lang;
        document.documentElement.dir = lang === 'ar' ? 'rtl' : 'ltr';
        $('langToggleBtn').innerText = lang === 'ar' ? 'English' : 'Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©';
        document.querySelectorAll('[data-translate]').forEach(el => {
            const key = el.getAttribute('data-translate');
            if (translations[lang][key]) {
                 if (el.tagName === 'P' && el.classList.contains('small')) {
                    el.innerText = translations[lang][key] || el.innerText;
                } else {
                    el.innerText = translations[lang][key];
                }
            }
        });
        document.querySelectorAll('[data-translate-placeholder]').forEach(el => {
            const key = el.getAttribute('data-translate-placeholder');
            if (translations[lang][key]) el.placeholder = translations[lang][key];
        });
        updateMainActionButtonsText();
    }
    
    function updateMainActionButtonsText() {
        const t = translations[currentLang];
        $('generateBtn').innerText = editingInvoiceId ? t.updateBtnText : t.generateBtn;
        $('saveReceiptBtn').innerText = editingReceiptId ? t.updateReceiptBtnText : t.saveReceiptBtn;
        $('saveItemBtn').innerText = editingItemId ? t.updateItemBtn : t.saveItemBtn;
        $('saveCustomerBtn').innerText = editingCustomerId ? t.updateCustomerBtn : t.saveCustomerBtn;
    }

    // --- Tab Switching ---
    function setupTabSwitching() {
        document.querySelectorAll('.tab-btn, .sub-tab-btn').forEach(button => {
            button.addEventListener('click', () => {
                const isMainTab = button.classList.contains('tab-btn');
                if(isMainTab){
                    document.querySelectorAll('.preview, .statement-preview').forEach(p => p.style.display = 'none');
                }
                const parentId = button.dataset.parent;
                const navSelector = isMainTab ? '.tabs-nav' : `div[id="${parentId}"] .sub-tabs-nav`;
                const contentSelector = isMainTab ? '.tab-content' : `div[id="${parentId}"] .sub-tab-content`;
                
                document.querySelectorAll(`${navSelector} > button`).forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');
                
                document.querySelectorAll(contentSelector).forEach(content => content.classList.remove('active'));
                $(button.dataset.tab).classList.add('active');
            });
        });
    }

    // --- Calculation and Rendering ---
    function calculateCustomerBalance(customerCode) {
        const totalInvoices = invoicesDB.filter(inv => inv.customerCode === customerCode).reduce((sum, inv) => sum + parseFloat(inv.grandTotal), 0);
        const totalReceipts = receiptsDB.filter(rec => rec.customerCode === customerCode).reduce((sum, rec) => sum + parseFloat(rec.amount), 0);
        return (totalInvoices - totalReceipts).toFixed(2);
    }
    function calculateItemSales(itemName) {
        return invoicesDB.reduce((totalQty, inv) => {
            const itemInInvoice = inv.items.find(item => item.description === itemName);
            return totalQty + (itemInInvoice ? parseFloat(itemInInvoice.quantity || 0) : 0);
        }, 0);
    }
    
    function renderAllLogs() {
        renderCustomersLog();
        renderInvoiceLog();
        renderReceiptLog();
        renderItemsLog();
    }
    
    // --- Data Management (Customers, Items, Invoices, Receipts) ---
    function renderCustomersLog() {
        const logBody = $('customersLogBody');
        logBody.innerHTML = '';
        const t = translations[currentLang];
        customersDB.forEach((cust) => {
            const balance = calculateCustomerBalance(cust.id);
            const balanceColor = parseFloat(balance) >= 0 ? 'blue' : 'red';
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${escapeHTML(cust.id)}</td>
                <td>${escapeHTML(cust.name)}</td>
                <td>${escapeHTML(cust.phone)}</td>
                <td style="color:${balanceColor}; font-weight:bold;">${balance}</td>
                <td class="actions">
                    <button class="btn warning small-action edit-btn" data-type="customer" data-id="${cust.id}">${t.editBtn}</button>
                    <button class="btn danger small-action delete-btn" data-type="customer" data-id="${cust.id}">${t.deleteBtn}</button>
                    <button class="btn info small-action statement-btn" data-type="customer" data-id="${cust.id}">${t.printStatement}</button>
                </td>`;
            logBody.appendChild(tr);
        });
        populateCustomersDatalist();
    }

    function populateCustomersDatalist() {
        const datalist = $('customersDatalist');
        if(!datalist) return;
        datalist.innerHTML = '';
        customersDB.forEach(cust => {
            datalist.innerHTML += `<option value="${escapeHTML(cust.name)}" data-code="${escapeHTML(cust.id)}"></option>`;
        });
    }

    function clearCustomerForm() {
        editingCustomerId = null;
        const fields = ['custCode', 'custName', 'custTaxNumber', 'custCrNumber', 'custNationalId', 'custPhone', 'custCity', 'custDistrict', 'custStreet', 'custPostalCode', 'custBuildingNumber', 'custAdditionalNumber'];
        fields.forEach(f => $(f).value = '');
        $('custCode').disabled = false;
        updateMainActionButtonsText();
    }
    
    function saveCustomer() {
        const id = $('custCode').value.trim();
        if (!id) { alert(translations[currentLang].customerCode + " is required."); return; }
        if (editingCustomerId === null && customersDB.some(c => c.id === id)) {
            alert("Customer code already exists.");
            return;
        }
        const customerData = {
            id, name: $('custName').value.trim(), taxNumber: $('custTaxNumber').value.trim(), crNumber: $('custCrNumber').value.trim(), nationalId: $('custNationalId').value.trim(), phone: $('custPhone').value.trim(),
            address: { city: $('custCity').value.trim(), district: $('custDistrict').value.trim(), street: $('custStreet').value.trim(), postalCode: $('custPostalCode').value.trim(), buildingNumber: $('custBuildingNumber').value.trim(), additionalNumber: $('custAdditionalNumber').value.trim() }
        };
        if (editingCustomerId !== null) {
            const index = customersDB.findIndex(c => c.id === editingCustomerId);
            if(index > -1) customersDB[index] = customerData;
        } else {
            customersDB.push(customerData);
        }
        clearCustomerForm();
        renderCustomersLog();
        saveAllDataToLocalStorage();
    }

    function renderItemsLog() {
        const logBody = $('itemsLogBody');
        logBody.innerHTML = '';
        const t = translations[currentLang];
        itemsDB.forEach((item, index) => {
            const qtySold = calculateItemSales(item.name);
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${escapeHTML(item.name)}</td>
                <td>${item.price}</td>
                <td>${qtySold}</td>
                <td class="actions">
                    <button class="btn warning small-action edit-btn" data-type="item" data-id="${index}">${t.editBtn}</button>
                    <button class="btn danger small-action delete-btn" data-type="item" data-id="${index}">${t.deleteBtn}</button>
                </td>`;
            logBody.appendChild(tr);
        });
        populateItemsDatalist();
    }

    function populateItemsDatalist() {
        const datalist = $('itemsDatalist');
        if(!datalist) return;
        datalist.innerHTML = '';
        itemsDB.forEach(item => {
            datalist.innerHTML += `<option value="${escapeHTML(item.name)}"></option>`;
        });
    }

    function clearItemForm() {
        editingItemId = null;
        $('itemName').value = '';
        $('itemPrice').value = '';
        updateMainActionButtonsText();
    }

    function saveItem() {
        const name = $('itemName').value.trim();
        const price = parseFloat($('itemPrice').value) || 0;
        if (!name) return;
        if (editingItemId !== null) {
            itemsDB[editingItemId] = { name, price };
        } else {
            itemsDB.push({ name, price });
        }
        clearItemForm();
        renderItemsLog();
        saveAllDataToLocalStorage();
    }
    
    function renderInvoiceLog() {
        const logBody = $('invoiceLogBody');
        logBody.innerHTML = '';
        const t = translations[currentLang];
        invoicesDB.forEach((inv) => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${escapeHTML(inv.invoiceNumber)}</td><td>${formatDate(inv.invoiceDate)}</td>
                <td>${escapeHTML(inv.customerName)}</td><td>${inv.grandTotal}</td>
                <td class="actions">
                    <button class="btn warning small-action edit-btn" data-type="invoice" data-id="${inv.invoiceNumber}">${t.editBtn}</button>
                    <button class="btn danger small-action delete-btn" data-type="invoice" data-id="${inv.invoiceNumber}">${t.deleteBtn}</button>
                    <button class="btn secondary small-action print-btn" data-type="invoice" data-id="${inv.invoiceNumber}">${t.printBtn}</button>
                </td>`;
            logBody.appendChild(tr);
        });
    }
    
    function clearInvoiceForm() {
        editingInvoiceId = null;
        $('invoiceNumber').value = '';
        $('invoiceDate').value = toLocalDateTime();
        $('customerName').value = '';
        $('customerTaxNumber').value = '';
        $('customerBalanceDisplay').textContent = '';
        $('itemsBody').innerHTML = '';
        addItem('', 1, 0);
        updateMainActionButtonsText();
    }

    function saveInvoice() {
        const customerName = $("customerName").value;
        const selectedOption = Array.from($('customersDatalist').options).find(opt => opt.value === customerName);
        const customerCode = selectedOption ? selectedOption.dataset.code : null;
        if (!customerCode) { alert("Please select a valid customer."); return null; }
        const invoiceNumber = $("invoiceNumber").value.trim() || `INV-${Date.now()}`;
        if (editingInvoiceId === null && invoicesDB.some(inv => inv.invoiceNumber === invoiceNumber)) {
            alert(`Invoice number ${invoiceNumber} already exists.`); return null;
        }
        const invoiceData = {
            invoiceNumber, invoiceDate: new Date($('invoiceDate').value).toISOString(), customerCode, customerName,
            subTotal: parseFloat($("subTotal").innerText).toFixed(2), vatTotal: parseFloat($("vatTotal").innerText).toFixed(2), grandTotal: parseFloat($("grandTotal").innerText).toFixed(2),
            items: Array.from($('itemsBody').querySelectorAll('tr')).map(r => ({ description: r.querySelector('.txt-desc').value, quantity: r.querySelector('.txt-qty').value, price: r.querySelector('.txt-price').value, total: r.querySelector('.cell-line-total').innerText }))
        };
        if (editingInvoiceId) {
            const index = invoicesDB.findIndex(inv => inv.invoiceNumber === editingInvoiceId);
            if (index > -1) invoicesDB[index] = invoiceData;
        } else {
            invoicesDB.push(invoiceData);
        }
        renderAllLogs();
        clearInvoiceForm();
        saveAllDataToLocalStorage();
        return invoiceData;
    }

    function renderReceiptLog() {
        const logBody = $('receiptLogBody');
        logBody.innerHTML = '';
        const t = translations[currentLang];
        receiptsDB.forEach((rec) => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${escapeHTML(rec.receiptNumber)}</td><td>${formatDate(rec.date)}</td>
                <td>${escapeHTML(rec.customerName)}</td><td>${rec.amount}</td>
                <td class="actions">
                    <button class="btn warning small-action edit-btn" data-type="receipt" data-id="${rec.receiptNumber}">${t.editBtn}</button>
                    <button class="btn danger small-action delete-btn" data-type="receipt" data-id="${rec.receiptNumber}">${t.deleteBtn}</button>
                    <button class="btn secondary small-action print-btn" data-type="receipt" data-id="${rec.receiptNumber}">${t.printBtn}</button>
                </td>`;
            logBody.appendChild(tr);
        });
    }

    function clearReceiptForm() {
        editingReceiptId = null;
        $('receiptNumber').value = '';
        $('receiptDate').value = toLocalDateTime();
        $('receiptCustomerName').value = '';
        $('amountReceived').value = '';
        $('receiptDescription').value = '';
        $('receiptCustomerBalanceDisplay').textContent = '';
        updateMainActionButtonsText();
    }
    
    function saveReceipt() {
        const customerName = $("receiptCustomerName").value;
        const selectedOption = Array.from($('customersDatalist').options).find(opt => opt.value === customerName);
        const customerCode = selectedOption ? selectedOption.dataset.code : null;
        if (!customerCode) { alert("Please select a valid customer."); return null; }
        const receiptNumber = $('receiptNumber').value.trim() || `REC-${Date.now()}`;
        if (editingReceiptId === null && receiptsDB.some(rec => rec.receiptNumber === receiptNumber)) {
            alert(`Receipt number ${receiptNumber} already exists.`); return null;
        }
        const receiptData = {
            receiptNumber, date: new Date($('receiptDate').value).toISOString(), customerCode, customerName,
            amount: parseFloat($('amountReceived').value) || 0, paymentMethod: $('paymentMethod').value, description: $('receiptDescription').value,
        };
        if (editingReceiptId) {
            const index = receiptsDB.findIndex(rec => rec.receiptNumber === editingReceiptId);
            if (index > -1) receiptsDB[index] = receiptData;
        } else {
            receiptsDB.push(receiptData);
        }
        renderAllLogs();
        clearReceiptForm();
        saveAllDataToLocalStorage();
        return receiptData;
    }

    // --- Invoice Item Management ---
    function recalcAll() {
        let subtotal = 0;
        $('itemsBody').querySelectorAll('tr').forEach(r => {
            const qty = parseFloat(r.querySelector('.txt-qty').value) || 0;
            const price = parseFloat(r.querySelector('.txt-price').value) || 0;
            const lineTotal = qty * price;
            r.querySelector('.cell-line-total').innerText = lineTotal.toFixed(2);
            subtotal += lineTotal;
        });
        const vat = subtotal * 0.15;
        const total = subtotal + vat;
        $("subTotal").innerText = subtotal.toFixed(2);
        $("vatTotal").innerText = vat.toFixed(2);
        $("grandTotal").innerText = total.toFixed(2);
    }
    function addItem(desc = '', qty = 1, price = 0) {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td><input class="txt-desc" type="text" value="${escapeHTML(desc)}" list="itemsDatalist"></td>
            <td><input class="txt-qty" type="number" min="0" step="any" value="${qty}"></td>
            <td><input class="txt-price" type="number" min="0" step="any" value="${price}"></td>
            <td class="cell-line-total">0.00</td>
            <td><button class="btn danger btn-del no-print">${translations[currentLang].deleteBtn}</button></td>`;
        $('itemsBody').appendChild(tr);
        const descInput = tr.querySelector('.txt-desc');
        descInput.addEventListener('input', () => {
            const selectedItem = itemsDB.find(i => i.name === descInput.value);
            if (selectedItem) { tr.querySelector('.txt-price').value = selectedItem.price; recalcAll(); }
        });
        tr.querySelectorAll('input').forEach(inp => inp.addEventListener('input', recalcAll));
        tr.querySelector('.btn-del').addEventListener('click', () => { tr.remove(); recalcAll(); });
        recalcAll();
    }
    
    // --- Previews and Printing ---
    function zatcaDataToBase64(sellerName, sellerTaxNumber, timestamp, invoiceTotal, vatTotal) {
        const toTlv = (tag, value) => {
            const valBytes = new TextEncoder().encode(String(value));
            const tlv = new Uint8Array(2 + valBytes.length);
            tlv[0] = tag; tlv[1] = valBytes.length; tlv.set(valBytes, 2);
            return tlv;
        };
        const parts = [toTlv(1, sellerName), toTlv(2, sellerTaxNumber), toTlv(3, timestamp), toTlv(4, String(invoiceTotal)), toTlv(5, String(vatTotal))];
        const combined = new Uint8Array(parts.reduce((acc, p) => acc + p.length, 0));
        let offset = 0;
        parts.forEach(p => { combined.set(p, offset); offset += p.length; });
        return btoa(String.fromCharCode.apply(null, combined));
    }

    function generateInvoicePreview(invoiceData) {
        if (!invoiceData) return;
        const t = translations[currentLang];
        const customer = customersDB.find(c => c.id === invoiceData.customerCode);
        $('previewSellerName').innerText = sellerInfo.name;
        $('previewSellerInfo').innerHTML = `${sellerInfo.address}<br>${t.phone}: ${sellerInfo.phone}<br>${t.sellerTaxNumber}: ${sellerInfo.taxNumber}`;
        $('invoiceTitle').innerText = t.simplifiedTaxInvoice;
        let clientHtml = '';
        if (customer) {
            const addr = customer.address || {};
            const fullAddress = `${addr.buildingNumber} ${addr.street}, ${addr.district}, ${addr.city} ${addr.postalCode}`;
            clientHtml = `<div class="detail-row"><div class="detail-label">${t.customerName}:</div><div>${escapeHTML(customer.name)}</div></div>` +
                         `<div class="detail-row"><div class="detail-label">${t.customerTaxNumber}:</div><div>${escapeHTML(customer.taxNumber)}</div></div>` +
                         `<div class="detail-row"><div class="detail-label">${t.crNumber}:</div><div>${escapeHTML(customer.crNumber)}</div></div>` +
                         `<div class="detail-row"><div class="detail-label">${t.phone}:</div><div>${escapeHTML(customer.phone)}</div></div>` +
                         `<div class="detail-row"><div class="detail-label">${t.nationalAddress}:</div><div>${escapeHTML(fullAddress)}</div></div>`;
        }
        $('previewClient').innerHTML = clientHtml;
        $('previewInvoiceNo').innerText = invoiceData.invoiceNumber;
        $('previewDate').innerText = formatDate(invoiceData.invoiceDate);
        let itemsHtml = `<table class="items-table" style="font-size:14px; text-align:center;"><thead><tr><th>${t.itemDescription}</th><th>${t.itemQty}</th><th>${t.itemUnitPrice}</th><th>${t.itemTotal}</th></tr></thead><tbody>`;
        invoiceData.items.forEach(item => { itemsHtml += `<tr><td>${escapeHTML(item.description)}</td><td>${escapeHTML(item.quantity)}</td><td>${parseFloat(item.price||0).toFixed(2)}</td><td>${parseFloat(item.total||0).toFixed(2)}</td></tr>`; });
        $('previewItems').innerHTML = itemsHtml + '</tbody></table>';
        $('previewTotals').innerHTML = `<table style="width:50%;margin-${currentLang==='ar'?'right':'left'}:auto;margin-${currentLang==='ar'?'left':'right'}:0;"><tr><td>${t.subTotalLabel}</td><td>${invoiceData.subTotal} SAR</td></tr><tr><td>${t.vatTotalLabel}</td><td>${invoiceData.vatTotal} SAR</td></tr><tr><td><b>${t.grandTotalLabel}</b></td><td><b>${invoiceData.grandTotal} SAR</b></td></tr></table>`;
        const tlvBase64 = zatcaDataToBase64(sellerInfo.name, sellerInfo.taxNumber, invoiceData.invoiceDate, invoiceData.grandTotal, invoiceData.vatTotal);
        $('qrContainer').innerHTML = '';
        new QRCode($("qrContainer"), { text: tlvBase64, width: 140, height: 140 });
        document.querySelectorAll('.preview, .statement-preview').forEach(p => p.style.display = 'none');
        $('invoicePreview').style.display = 'block';
    }

    function generateReceiptPreview(receiptData) {
        if (!receiptData) return;
        const t = translations[currentLang];
        $('receiptPreviewSellerName').innerText = sellerInfo.name;
        $('receiptPreviewSellerInfo').innerText = `${sellerInfo.address} | ${sellerInfo.phone}`;
        $('receiptPreviewNumber').innerText = receiptData.receiptNumber;
        $('receiptPreviewDate').innerText = formatDate(receiptData.date);
        $('receiptPreviewCustomer').innerText = receiptData.customerName;
        $('receiptPreviewAmount').innerText = `${parseFloat(receiptData.amount).toFixed(2)} SAR`;
        $('receiptPreviewDesc').innerText = receiptData.description;
        $('receiptPreviewPayment').innerText = t[Object.keys(t).find(k => t[k] === receiptData.paymentMethod)] || receiptData.paymentMethod;
        document.querySelectorAll('.preview, .statement-preview').forEach(p => p.style.display = 'none');
        $('receiptPreview').style.display = 'block';
    }

    function generateStatementPreview(customerCode) {
        const customer = customersDB.find(c => c.id === customerCode);
        if (!customer) return;
        const t = translations[currentLang];
        $('statementSellerName').innerText = sellerInfo.name;
        $('statementSellerInfo').innerText = `${sellerInfo.address} | ${sellerInfo.phone}`;
        $('statementClientInfo').innerHTML = `<strong>${t.customerName}:</strong> ${customer.name} | <strong>${t.customerCode}:</strong> ${customer.id}`;
        const customerInvoices = invoicesDB.filter(inv => inv.customerCode === customerCode).map(inv => ({ date: new Date(inv.invoiceDate), desc: `${t.logInvoiceNumber} ${inv.invoiceNumber}`, debit: parseFloat(inv.grandTotal), credit: 0 }));
        const customerReceipts = receiptsDB.filter(rec => rec.customerCode === customerCode).map(rec => ({ date: new Date(rec.date), desc: `${t.logReceiptNumber} ${rec.receiptNumber}`, debit: 0, credit: parseFloat(rec.amount) }));
        const transactions = [...customerInvoices, ...customerReceipts].sort((a,b) => a.date - b.date);
        const tableBody = $('statementTableBody');
        tableBody.innerHTML = '';
        let runningBalance = 0;
        transactions.forEach(tx => {
            runningBalance += tx.debit - tx.credit;
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${formatDate(tx.date)}</td><td>${escapeHTML(tx.desc)}</td><td>${tx.debit.toFixed(2)}</td><td>${tx.credit.toFixed(2)}</td><td>${runningBalance.toFixed(2)}</td>`;
            tableBody.appendChild(tr);
        });
        $('statementSummary').innerHTML = `<strong>${t.closingBalance}: ${runningBalance.toFixed(2)} SAR</strong>`;
        document.querySelectorAll('.preview, .statement-preview').forEach(p => p.style.display = 'none');
        $('statementPreview').style.display = 'block';
    }

    function handleCustomerSelection(e, balanceDisplayId) {
        const input = e.target;
        const balanceDisplay = $(balanceDisplayId);
        balanceDisplay.textContent = '';
        const selectedOption = Array.from(document.getElementById('customersDatalist').options).find(opt => opt.value === input.value);
        if (selectedOption) {
            const customerCode = selectedOption.dataset.code;
            const customer = customersDB.find(c => c.id === customerCode);
            if (customer) {
                if (input.id === 'customerName') { $('customerTaxNumber').value = customer.taxNumber; }
                const balance = calculateCustomerBalance(customer.id);
                balanceDisplay.textContent = `${translations[currentLang].balance}: ${balance}`;
            }
        }
    }
    
    // --- Settings and Data Backup/Restore ---
    function loadSettingsForm() {
        $('settingSellerName').value = sellerInfo.name;
        $('settingSellerTaxNum').value = sellerInfo.taxNumber;
        $('settingSellerAddress').value = sellerInfo.address;
        $('settingSellerPhone').value = sellerInfo.phone;
    }
    function saveSettings() {
        sellerInfo.name = $('settingSellerName').value;
        sellerInfo.taxNumber = $('settingSellerTaxNum').value;
        sellerInfo.address = $('settingSellerAddress').value;
        sellerInfo.phone = $('settingSellerPhone').value;
        saveAllDataToLocalStorage();
        alert("ØªÙ… Ø­ÙØ¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø´Ø±ÙƒØ©.");
    }

    function exportAllData() {
        const workbook = XLSX.utils.book_new();
        const flattenedCustomers = customersDB.map(c => ({ ...(c.address || {}), ...c, address: undefined }));
        const invoicesForExport = invoicesDB.map(invoice => ({ ...invoice, items: JSON.stringify(invoice.items || []) }));
        XLSX.utils.book_append_sheet(workbook, XLSX.utils.json_to_sheet(flattenedCustomers), "Customers");
        XLSX.utils.book_append_sheet(workbook, XLSX.utils.json_to_sheet(itemsDB), "Items");
        XLSX.utils.book_append_sheet(workbook, XLSX.utils.json_to_sheet(invoicesForExport), "Invoices");
        XLSX.utils.book_append_sheet(workbook, XLSX.utils.json_to_sheet(receiptsDB), "Receipts");
        XLSX.utils.book_append_sheet(workbook, XLSX.utils.json_to_sheet([sellerInfo]), "Settings");
        XLSX.writeFile(workbook, `backup-${loggedInUser}-${new Date().toISOString().slice(0,10)}.xlsx`);
    }

    function importAllData(event) {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: "array" });
                const safeSheetToJSON = (sheetName) => workbook.Sheets[sheetName] ? XLSX.utils.sheet_to_json(workbook.Sheets[sheetName]) : [];

                const importedCustomers = safeSheetToJSON("Customers").map(c => ({ id: c.id, name: c.name, taxNumber: c.taxNumber, crNumber: c.crNumber, nationalId: c.nationalId, phone: c.phone, address: { city: c.city, district: c.district, street: c.street, postalCode: c.postalCode, buildingNumber: c.buildingNumber, additionalNumber: c.additionalNumber }}));
                const importedItems = safeSheetToJSON("Items");
                const importedReceipts = safeSheetToJSON("Receipts");
                const importedSettings = safeSheetToJSON("Settings");
                const importedInvoices = safeSheetToJSON("Invoices").map(inv => ({ ...inv, items: typeof inv.items === 'string' ? JSON.parse(inv.items) : (inv.items || []) }));

                customersDB = importedCustomers;
                itemsDB = importedItems;
                invoicesDB = importedInvoices;
                receiptsDB = importedReceipts;
                if (importedSettings.length > 0) sellerInfo = importedSettings[0];
                
                saveAllDataToLocalStorage();
                alert(translations[currentLang].importSuccess);
                location.reload(); 
            } catch (err) {
                console.error(err);
                alert(translations[currentLang].importError);
            }
        };
        reader.readAsArrayBuffer(file);
        event.target.value = '';
    }

    // --- MODIFIED: Clear Data for the current user ---
    function clearCurrentUserData() {
        if (confirm(translations[currentLang].confirmClearAll)) {
            localStorage.removeItem(`accountingData_${loggedInUser}`);
            location.reload();
        }
    }

    // --- UNIVERSAL EVENT HANDLERS ---
    function handleEdit(type, id) {
        if (type === 'customer') {
            const cust = customersDB.find(c => c.id === id);
            if (!cust) return;
            editingCustomerId = id;
            $('custCode').value = cust.id; $('custCode').disabled = true;
            $('custName').value = cust.name; $('custTaxNumber').value = cust.taxNumber;
            $('custCrNumber').value = cust.crNumber; $('custNationalId').value = cust.nationalId; $('custPhone').value = cust.phone;
            const addr = cust.address || {};
            $('custCity').value = addr.city; $('custDistrict').value = addr.district; $('custStreet').value = addr.street;
            $('custPostalCode').value = addr.postalCode; $('custBuildingNumber').value = addr.buildingNumber; $('custAdditionalNumber').value = addr.additionalNumber;
            updateMainActionButtonsText();
            document.querySelector('.tab-btn[data-tab="customersTab"]').click();
            document.querySelector('.sub-tab-btn[data-tab="createCustomer"]').click();
        } else if (type === 'item') {
            const item = itemsDB[id];
            if (!item) return;
            editingItemId = id;
            $('itemName').value = item.name; $('itemPrice').value = item.price;
            updateMainActionButtonsText();
            document.querySelector('.tab-btn[data-tab="itemsTab"]').click();
            document.querySelector('.sub-tab-btn[data-tab="createItem"]').click();
        } else if (type === 'invoice') {
            const inv = invoicesDB.find(i => i.invoiceNumber === id);
            if (!inv) return;
            editingInvoiceId = id;
            $('invoiceNumber').value = inv.invoiceNumber; $('invoiceDate').value = toLocalDateTime(new Date(inv.invoiceDate));
            $('customerName').value = inv.customerName;
            handleCustomerSelection({target: $('customerName')}, 'customerBalanceDisplay');
            $('itemsBody').innerHTML = '';
            inv.items.forEach(item => addItem(item.description, item.quantity, item.price));
            updateMainActionButtonsText();
            document.querySelector('.tab-btn[data-tab="invoiceTab"]').click();
            document.querySelector('.sub-tab-btn[data-tab="createInvoice"]').click();
        } else if (type === 'receipt') {
            const rec = receiptsDB.find(r => r.receiptNumber === id);
            if (!rec) return;
            editingReceiptId = id;
            $('receiptNumber').value = rec.receiptNumber; $('receiptDate').value = toLocalDateTime(new Date(rec.date));
            $('receiptCustomerName').value = rec.customerName;
            $('amountReceived').value = rec.amount; $('paymentMethod').value = rec.paymentMethod; $('receiptDescription').value = rec.description;
            handleCustomerSelection({target: $('receiptCustomerName')}, 'receiptCustomerBalanceDisplay');
            updateMainActionButtonsText();
            document.querySelector('.tab-btn[data-tab="receiptTab"]').click();
            document.querySelector('.sub-tab-btn[data-tab="createReceipt"]').click();
        }
    }
    function handleDelete(type, id) {
        if (!confirm(translations[currentLang].confirmDelete)) return;
        if (type === 'customer') {
            const balance = calculateCustomerBalance(id);
            if (parseFloat(balance) !== 0 && !confirm("This customer has a balance. Are you sure?")) return;
            const index = customersDB.findIndex(c => c.id === id);
            if (index > -1) customersDB.splice(index, 1);
        } else if (type === 'item') {
            itemsDB.splice(id, 1);
        } else if (type === 'invoice') {
            const index = invoicesDB.findIndex(i => i.invoiceNumber === id);
            if (index > -1) invoicesDB.splice(index, 1);
        } else if (type === 'receipt') {
            const index = receiptsDB.findIndex(r => r.receiptNumber === id);
            if (index > -1) receiptsDB.splice(index, 1);
        }
        renderAllLogs();
        saveAllDataToLocalStorage();
    }
    function handlePrint(type, id) {
        if (type === 'invoice') {
            const inv = invoicesDB.find(i => i.invoiceNumber === id);
            if (inv) { generateInvoicePreview(inv); document.body.className = 'printing-invoice'; window.print(); }
        } else if (type === 'receipt') {
            const rec = receiptsDB.find(r => r.receiptNumber === id);
            if (rec) { generateReceiptPreview(rec); document.body.className = 'printing-receipt'; window.print(); }
        }
    }
    
    // --- Initialisation ---
    function initializeApp() {
        // Load data first
        loadAllDataFromLocalStorage();

        // --- NEW: Setup welcome message and logout ---
        $('welcomeUser').innerText = `Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ ${loggedInUser}`;
        $('logoutBtn').addEventListener('click', () => {
            sessionStorage.removeItem('loggedInUser');
            window.location.href = 'login.html';
        });

        // Event Listeners for main actions
        $('langToggleBtn').addEventListener('click', () => setLanguage(currentLang === 'ar' ? 'en' : 'ar'));
        $('saveSettingsBtn').addEventListener('click', saveSettings);
        $('exportAllBtn').addEventListener('click', exportAllData);
        $('importAllFile').addEventListener('change', importAllData);
        $('clearAllDataBtn').addEventListener('click', clearCurrentUserData);

        $('saveCustomerBtn').addEventListener('click', saveCustomer);
        $('clearCustomerFormBtn').addEventListener('click', clearCustomerForm);
        $('saveItemBtn').addEventListener('click', saveItem);
        $('clearItemFormBtn').addEventListener('click', clearItemForm);
        $('newInvoiceBtn').addEventListener('click', clearInvoiceForm);
        $('generateBtn').addEventListener('click', saveInvoice);
        $('addItemBtn').addEventListener('click', () => addItem());
        $('newReceiptBtn').addEventListener('click', clearReceiptForm);
        $('saveReceiptBtn').addEventListener('click', saveReceipt);
        $('printInvoiceBtn').addEventListener('click', () => {
            recalcAll();
            const customerName = $("customerName").value;
            const selectedOption = Array.from($('customersDatalist').options).find(opt => opt.value === customerName);
            if (!selectedOption) { alert("Please select a customer to print."); return; }
            const formData = {
                invoiceNumber: $("invoiceNumber").value.trim() || `INV-${Date.now()}`, invoiceDate: new Date($('invoiceDate').value).toISOString(), customerCode: selectedOption.dataset.code, customerName,
                subTotal: parseFloat($("subTotal").innerText).toFixed(2), vatTotal: parseFloat($("vatTotal").innerText).toFixed(2), grandTotal: parseFloat($("grandTotal").innerText).toFixed(2),
                items: Array.from($('itemsBody').querySelectorAll('tr')).map(r => ({ description: r.querySelector('.txt-desc').value, quantity: r.querySelector('.txt-qty').value, price: r.querySelector('.txt-price').value, total: r.querySelector('.cell-line-total').innerText }))
            };
            generateInvoicePreview(formData);
            document.body.className = 'printing-invoice';
            window.print();
        });
        $('printReceiptBtn').addEventListener('click', () => {
            const customerName = $("receiptCustomerName").value;
            const selectedOption = Array.from($('customersDatalist').options).find(opt => opt.value === customerName);
            if (!selectedOption) { alert("Please select a customer to print."); return; }
            const receiptData = {
                receiptNumber: $('receiptNumber').value.trim() || `REC-${Date.now()}`, date: new Date($('receiptDate').value).toISOString(), customerCode: selectedOption.dataset.code, customerName,
                amount: parseFloat($('amountReceived').value) || 0, paymentMethod: $('paymentMethod').value, description: $('receiptDescription').value,
            };
            generateReceiptPreview(receiptData);
            document.body.className = 'printing-receipt';
            window.print();
        });

        // Event listener for dynamic content in tables
        document.body.addEventListener('click', function(e){
            const target = e.target;
            const id = target.dataset.id;
            const type = target.dataset.type;
            if (target.classList.contains('edit-btn') || target.classList.contains('delete-btn') || target.classList.contains('print-btn') || target.classList.contains('statement-btn')) {
                if (!id && id !== 0 || !type) return;
                if (target.classList.contains('edit-btn')) handleEdit(type, id); 
                else if (target.classList.contains('delete-btn')) handleDelete(type, id); 
                else if (target.classList.contains('print-btn')) handlePrint(type, id); 
                else if (target.classList.contains('statement-btn')) {
                    generateStatementPreview(id);
                    document.body.className = 'printing-statement';
                    window.print();
                }
            }
        });
        
        // Customer selection listeners
        $('customerName').addEventListener('input', e => handleCustomerSelection(e, 'customerBalanceDisplay'));
        $('receiptCustomerName').addEventListener('input', e => handleCustomerSelection(e, 'receiptCustomerBalanceDisplay'));
        
        // Default to log view on main tab click
        const mainTabs = [
            { tab: 'invoiceTab', log: 'invoiceLog' },
            { tab: 'receiptTab', log: 'receiptLog' },
            { tab: 'itemsTab', log: 'itemLog' },
            { tab: 'customersTab', log: 'customerLog' }
        ];
        mainTabs.forEach(item => {
            const tabButton = document.querySelector(`.tab-btn[data-tab="${item.tab}"]`);
            if (tabButton) {
                tabButton.addEventListener('click', () => {
                    document.querySelector(`.sub-tab-btn[data-tab="${item.log}"]`)?.click();
                });
            }
        });

        // Final setup calls
        setupTabSwitching();
        loadSettingsForm();
        renderAllLogs();
        clearInvoiceForm();
        clearReceiptForm();
        clearCustomerForm();
        clearItemForm();
        setLanguage('ar');
        
        document.body.addEventListener('afterprint', () => { document.body.className = ''; });
    }
    
    initializeApp();
});
</script>
</body>
</html>