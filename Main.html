<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title data-translate="pageTitle">نظام الفواتير وسندات التحصيل</title>
<script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
  :root{
    --accent:#0a6efd; --muted:#666; --card:#ffffff; --bg:#f4f6fb; --paper-margin:12mm;
    --danger: #dc3545; --warning: #ffc107; --success: #198754; --secondary: #374151; --info: #0dcaf0;
  }
  *{box-sizing:border-box}
  body{font-family: "Segoe UI", Tahoma, Arial, Helvetica, sans-serif; margin:0; background:var(--bg); color:#111;}
  .wrap{max-width:1140px;margin:18px auto;padding:18px;}
  .card{background:var(--card);border-radius:10px;box-shadow:0 8px 30px rgba(10,20,40,0.06);padding:16px}
  .form-section{border-bottom:1px solid #e5e7eb;padding-bottom:12px;margin-bottom:12px}
  h1,h2,h3{margin:0 0 10px;color:var(--accent)}
  h1{font-size:20px;text-align:center;} h2{font-size:16px;color:#333} h3{font-size:15px;color:var(--muted); margin-top:16px;}
  .row{display:flex;gap:12px;flex-wrap:wrap}
  .col{flex:1 1 220px;min-width:180px}
  label{display:block;font-weight:600;margin-bottom:6px;font-size:14px;}
  input, select, textarea {width:100%;padding:8px;border:1px solid #d8dbe0;border-radius:6px;font-size:14px; background: #fff;}
  .small{font-size:13px;color:var(--muted)}
  .items-table, .log-table {width:100%;border-collapse:collapse;margin-top:12px; font-size: 14px;}
  .items-table th,.items-table td, .log-table th, .log-table td {border:1px solid #e5e7eb;padding:8px;text-align:center; vertical-align: middle;}
  .items-table th, .log-table th {background:#fbfdff;font-weight:700}
  .btn{display:inline-block;padding:8px 12px;border-radius:8px;border:none;cursor:pointer;background:var(--accent);color:#fff;font-weight:700; font-size: 14px; margin: 2px;}
  .btn.info{background: var(--info); color: #000;} .btn.secondary{background:var(--secondary)} .btn.success{background:var(--success)}
  .btn.danger{background:var(--danger)} .btn.warning{background:var(--warning); color: #111;}
  .btn.small-action{padding: 4px 8px; font-size: 12px;}
  .actions{display:flex;gap:10px;flex-wrap:wrap;margin-bottom: 12px; justify-content: center; align-items: center;}
  .customer-balance-display { font-size: 12px; font-weight: bold; color: var(--accent); margin: 0 8px; white-space: nowrap;}
  
  .preview, .statement-preview {display:none; margin-top:18px;padding:20px;border-radius:8px;background:#fff;border:1px solid #eef2ff}
  
  .tabs-nav, .sub-tabs-nav { display: flex; border-bottom: 2px solid #e5e7eb; margin-bottom: 16px; flex-wrap: wrap;}
  .tab-btn, .sub-tab-btn { padding: 10px 20px; cursor: pointer; border: none; background: transparent; font-size: 16px; font-weight: 600; color: var(--muted); border-bottom: 2px solid transparent; margin-bottom: -2px; }
  .tab-btn.active, .sub-tab-btn.active { color: var(--accent); border-bottom-color: var(--accent); }
  .tab-content, .sub-tab-content { display: none; }
  .tab-content.active, .sub-tab-content.active { display: block; animation: fadeIn 0.5s; }
  @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
  .header-controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; flex-wrap: wrap; gap: 10px;}
  .header-buttons { display: flex; gap: 8px; align-items: center; }
  
  .preview-client-details .detail-row { display: flex; margin-bottom: 4px; font-size: 14px;}
  .preview-client-details .detail-label { font-weight: bold; min-width: 120px; }
  body[dir="ltr"] .preview-client-details .detail-label { min-width: 150px; }
  .qr-block{text-align:center}
  #qrContainer { width: 140px; height: 140px; margin: auto; padding: 4px; background: white; border: 1px solid #eee; }
  #qrContainer canvas, #qrContainer img { display: block; width: 100% !important; height: 100% !important; }

  /* Improved Invoice Preview Design */
  .invoice-preview .inv-header { display: flex; justify-content: space-between; align-items: flex-start; }
  .invoice-preview .seller-block { text-align: right; }
  body[dir="ltr"] .invoice-preview .seller-block { text-align: left; }
  .invoice-preview .seller-block h2 { font-size: 22px; color: #000; margin-bottom: 8px;}
  .invoice-preview .invoice-title { text-align: center; margin: 20px 0; font-size: 24px; color: #333; text-decoration: underline;}

  /* --- NEW: Responsive CSS for Mobile --- */
  @media (max-width: 768px) {
    .log-table .actions {
      flex-direction: column; /* Stack buttons vertically */
      gap: 5px; /* Reduce gap between buttons */
    }
    .log-table .btn.small-action {
      width: 90%; /* Make buttons take more width */
      font-size: 11px;
    }
    .log-table td, .log-table th {
      padding: 6px 4px; /* Reduce padding in cells */
    }
     .header-controls {
        flex-direction: column;
        align-items: flex-start;
    }
  }

  @media print{
    body{background:white; color:black;}
    .wrap, .card {box-shadow:none;max-width:100%;margin:0;padding:0;border-radius:0;}
    .no-print {display:none !important}
    .preview, .statement-preview { display: none !important; border:none;margin:0;padding:0;border-radius:0;}
    body.printing-invoice .invoice-preview { display: block !important; }
    body.printing-receipt .receipt-preview { display: block !important; }
    body.printing-statement .statement-preview { display: block !important; }
    @page { size: A4; margin: var(--paper-margin); }
  }
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <div class="no-print">
      <div class="header-controls">
        <h1 data-translate="pageTitle" style="text-align: initial;">نظام الفواتير والسندات</h1>
        <div class="header-buttons">
          <span id="welcomeUser" style="font-weight: bold; margin: 0 10px; color: var(--muted); font-size: 14px;"></span>
          <button class="btn secondary" id="langToggleBtn">English</button>
          <button class="btn danger" id="logoutBtn" data-translate="logoutBtn">تسجيل الخروج</button>
        </div>
      </div>

      <div class="tabs-nav">
        <button class="tab-btn active" data-tab="invoiceTab" data-translate="invoiceTab">فاتورة ضريبية</button>
        <button class="tab-btn" data-tab="receiptTab" data-translate="receiptTab">سند تحصيل</button>
        <button class="tab-btn" data-tab="itemsTab" data-translate="itemsTab">الأصناف</button>
        <button class="tab-btn" data-tab="customersTab" data-translate="customersTab">العملاء</button>
        <button class="tab-btn" data-tab="settingsTab" data-translate="settingsTab">الإعدادات والبيانات</button>
      </div>

      <!-- Main Invoice Tab -->
      <div id="invoiceTab" class="tab-content active">
        <div class="sub-tabs-nav">
          <button class="sub-tab-btn active" data-tab="createInvoice" data-parent="invoiceTab" data-translate="createInvoiceSubTab">إنشاء فاتورة</button>
          <button class="sub-tab-btn" data-tab="invoiceLog" data-parent="invoiceTab" data-translate="invoiceLogSubTab">سجل الفواتير</button>
        </div>
        <div id="createInvoice" class="sub-tab-content active">
          <div class="actions">
            <button class="btn" id="newInvoiceBtn" data-translate="newInvoiceBtn">➕ جديد</button>
            <button class="btn success" id="generateBtn" data-translate="generateBtn">💾 حفظ</button>
            <button class="btn secondary" id="printInvoiceBtn" data-translate="printBtn">🖨️ طباعة</button>
          </div>
          <div class="form-section">
            <h2 data-translate="invoiceAndCustomerData">بيانات الفاتورة والعميل</h2>
            <div class="row">
              <div class="col"><label for="invoiceNumber" data-translate="invoiceNumber">رقم الفاتورة</label><input id="invoiceNumber" type="text"></div>
              <div class="col"><label for="invoiceDate" data-translate="invoiceDate">تاريخ الفاتورة</label><input id="invoiceDate" type="datetime-local"></div>
            </div>
            <div class="row" style="margin-top:8px">
              <div class="col" style="display: flex; align-items: center;">
                <div style="flex-grow: 1;">
                  <label for="customerName" data-translate="customerName">اسم العميل</label>
                  <input id="customerName" type="text" list="customersDatalist" data-translate-placeholder="customerNamePlaceholder">
                </div>
                <span id="customerBalanceDisplay" class="customer-balance-display"></span>
              </div>
              <div class="col"><label for="customerTaxNumber" data-translate="customerTaxNumber">الرقم الضريبي للعميل</label><input id="customerTaxNumber" type="text" readonly></div>
            </div>
          </div>
          <div class="form-section">
            <h2 style="margin-bottom:0" data-translate="items">الأصناف</h2>
            <table class="items-table" id="itemsTable">
                <thead><tr><th style="width:40%" data-translate="itemDescription">الوصف</th><th data-translate="itemQty">الكمية</th><th data-translate="itemUnitPrice">سعر الوحدة</th><th data-translate="itemTotal">الإجمالي</th><th style="width:70px" data-translate="itemAction">إجراء</th></tr></thead>
                <tbody id="itemsBody"></tbody>
            </table>
            <div style="margin-top:8px" class="controls"><button class="btn" id="addItemBtn" data-translate="addItemBtn">➕ إضافة صنف</button></div>
            <div class="summary">
              <div style="display:flex;justify-content:space-between;gap:12px;flex-wrap:wrap">
                <div><span data-translate="subTotalLabel">الإجمالي قبل الضريبة:</span> <strong id="subTotal">0.00</strong> SAR</div>
                <div><span data-translate="vatTotalLabel">قيمة الضريبة (15%):</span> <strong id="vatTotal">0.00</strong> SAR</div>
                <div><span data-translate="grandTotalLabel">الإجمالي الكلي:</span> <strong id="grandTotal">0.00</strong> SAR</div>
              </div>
            </div>
          </div>
        </div>
        <div id="invoiceLog" class="sub-tab-content">
           <h2 data-translate="invoiceLogTitle">سجل الفواتير</h2>
           <table class="log-table" id="invoiceLogTable">
              <thead><tr><th data-translate="logInvoiceNumber">رقم الفاتورة</th><th data-translate="logDate">التاريخ</th><th data-translate="logCustomer">العميل</th><th data-translate="logTotal">الإجمالي</th><th data-translate="logActions">إجراءات</th></tr></thead>
              <tbody id="invoiceLogBody"></tbody>
           </table>
        </div>
      </div>

      <!-- Main Receipt Tab -->
      <div id="receiptTab" class="tab-content">
        <div class="sub-tabs-nav">
          <button class="sub-tab-btn active" data-tab="createReceipt" data-parent="receiptTab" data-translate="createReceiptSubTab">إنشاء سند</button>
          <button class="sub-tab-btn" data-tab="receiptLog" data-parent="receiptTab" data-translate="receiptLogSubTab">سجل السندات</button>
        </div>
        <div id="createReceipt" class="sub-tab-content active">
          <h1 data-translate="salesReceiptVoucher">سند تحصيل مبيعات</h1>
           <div class="actions">
            <button class="btn" id="newReceiptBtn" data-translate="newReceiptBtn">➕ جديد</button>
            <button class="btn success" id="saveReceiptBtn" data-translate="saveReceiptBtn">💾 حفظ السند</button>
            <button class="btn secondary" id="printReceiptBtn" data-translate="printReceiptBtn">🖨️ طباعة السند</button>
          </div>
          <div class="form-section">
            <h2 data-translate="voucherData">بيانات السند</h2>
            <div class="row">
                <div class="col"><label for="receiptNumber" data-translate="receiptNumber">رقم السند</label><input id="receiptNumber" type="text"></div>
                <div class="col"><label for="receiptDate" data-translate="receiptDate">تاريخ السند</label><input id="receiptDate" type="datetime-local"></div>
            </div>
          </div>
          <div class="form-section">
            <h2 data-translate="customerAndCollectionData">بيانات العميل والتحصيل</h2>
             <div class="row">
                <div class="col" style="display: flex; align-items: center;">
                  <div style="flex-grow: 1;">
                    <label for="receiptCustomerName" data-translate="receiptCustomerName">اسم العميل</label>
                    <input id="receiptCustomerName" type="text" list="customersDatalist" data-translate-placeholder="receiptCustomerNamePlaceholder">
                  </div>
                  <span id="receiptCustomerBalanceDisplay" class="customer-balance-display"></span>
                </div>
                <div class="col"><label for="amountReceived" data-translate="amountReceived">المبلغ المستلم</label><input id="amountReceived" type="number" min="0" step="any" placeholder="0.00"></div>
             </div>
             <div class="row" style="margin-top:8px">
                <div class="col"><label for="paymentMethod" data-translate="paymentMethod">طريقة الدفع</label>
                    <select id="paymentMethod">
                        <option value="Cash" data-translate="paymentCash">نقدي</option>
                        <option value="Bank Transfer" data-translate="paymentBank">تحويل بنكي</option>
                        <option value="Credit Card" data-translate="paymentCard">بطاقة ائتمان</option>
                    </select>
                </div>
             </div>
          </div>
          <div class="form-section">
            <h2 data-translate="description">الوصف</h2>
            <div class="row"><div class="col"><label for="receiptDescription" data-translate="receiptDescriptionLabel">وصف عملية التحصيل</label><textarea id="receiptDescription" data-translate-placeholder="receiptDescriptionPlaceholder"></textarea></div></div>
          </div>
        </div>
        <div id="receiptLog" class="sub-tab-content">
          <h2 data-translate="receiptLogTitle">سجل سندات التحصيل</h2>
          <table class="log-table" id="receiptLogTable">
              <thead><tr><th data-translate="logReceiptNumber">رقم السند</th><th data-translate="logDate">التاريخ</th><th data-translate="logCustomer">العميل</th><th data-translate="logAmount">المبلغ</th><th data-translate="logActions">إجراءات</th></tr></thead>
              <tbody id="receiptLogBody"></tbody>
          </table>
        </div>
      </div>

      <!-- Items Management Tab -->
      <div id="itemsTab" class="tab-content">
        <div class="sub-tabs-nav">
            <button class="sub-tab-btn active" data-tab="createItem" data-parent="itemsTab" data-translate="createItemSubTab">إنشاء صنف</button>
            <button class="sub-tab-btn" data-tab="itemLog" data-parent="itemsTab" data-translate="itemLogSubTab">سجل الأصناف</button>
        </div>
        <div id="createItem" class="sub-tab-content active">
            <h2 data-translate="addNewItem">إضافة/تعديل صنف</h2>
            <div class="row">
                <div class="col"><label for="itemName" data-translate="itemName">اسم/وصف الصنف</label><input id="itemName" type="text"></div>
                <div class="col"><label for="itemPrice" data-translate="itemPrice">سعر الوحدة</label><input id="itemPrice" type="number" min="0" step="any"></div>
            </div>
            <div class="actions" style="margin-top: 16px;">
                <button class="btn success" id="saveItemBtn" data-translate="saveItemBtn">💾 حفظ الصنف</button>
                <button class="btn secondary" id="clearItemFormBtn" data-translate="clearFormBtn">➕ جديد</button>
            </div>
        </div>
        <div id="itemLog" class="sub-tab-content">
            <h2 data-translate="savedItems">الأصناف المحفوظة</h2>
            <table class="log-table" id="itemsLogTable">
                <thead><tr><th data-translate="itemName">اسم الصنف</th><th data-translate="itemPrice">السعر</th><th data-translate="qtySold">الكمية المباعة</th><th data-translate="logActions">إجراءات</th></tr></thead>
                <tbody id="itemsLogBody"></tbody>
            </table>
        </div>
      </div>
      
      <!-- Customers Management Tab -->
      <div id="customersTab" class="tab-content">
        <div class="sub-tabs-nav">
            <button class="sub-tab-btn active" data-tab="createCustomer" data-parent="customersTab" data-translate="createCustomerSubTab">إنشاء عميل</button>
            <button class="sub-tab-btn" data-tab="customerLog" data-parent="customersTab" data-translate="customerLogSubTab">سجل العملاء</button>
        </div>
        <div id="createCustomer" class="sub-tab-content active">
            <h2 data-translate="addNewCustomer">إضافة/تعديل عميل</h2>
            <div class="row">
                <div class="col"><label for="custCode" data-translate="customerCode">كود العميل</label><input id="custCode" type="text"></div>
                <div class="col"><label for="custName" data-translate="customerName">اسم العميل</label><input id="custName" type="text"></div>
                <div class="col"><label for="custTaxNumber" data-translate="customerTaxNumber">الرقم الضريبي</label><input id="custTaxNumber" type="text"></div>
            </div>
             <div class="row" style="margin-top:8px">
                <div class="col"><label for="custCrNumber" data-translate="crNumber">رقم السجل التجاري</label><input id="custCrNumber" type="text"></div>
                <div class="col"><label for="custNationalId" data-translate="nationalId">رقم الهوية</label><input id="custNationalId" type="text"></div>
                <div class="col"><label for="custPhone" data-translate="phone">رقم الهاتف</label><input id="custPhone" type="text"></div>
            </div>
            <h3 data-translate="nationalAddress">العنوان الوطني</h3>
            <div class="row">
                <div class="col"><label for="custCity" data-translate="city">المدينة</label><input id="custCity" type="text"></div>
                <div class="col"><label for="custDistrict" data-translate="district">الحي</label><input id="custDistrict" type="text"></div>
                <div class="col"><label for="custStreet" data-translate="street">الشارع</label><input id="custStreet" type="text"></div>
            </div>
            <div class="row" style="margin-top:8px">
                <div class="col"><label for="custPostalCode" data-translate="postalCode">الرمز البريدي</label><input id="custPostalCode" type="text" maxlength="5" oninput="this.value = this.value.replace(/[^0-9]/g, '')"></div>
                <div class="col"><label for="custBuildingNumber" data-translate="buildingNumber">رقم المبنى</label><input id="custBuildingNumber" type="text" maxlength="4" oninput="this.value = this.value.replace(/[^0-9]/g, '')"></div>
                <div class="col"><label for="custAdditionalNumber" data-translate="additionalNumber">الرقم الإضافي</label><input id="custAdditionalNumber" type="text" maxlength="4" oninput="this.value = this.value.replace(/[^0-9]/g, '')"></div>
            </div>
            <div class="actions" style="margin-top: 16px;">
                <button class="btn success" id="saveCustomerBtn" data-translate="saveCustomerBtn">💾 حفظ العميل</button>
                <button class="btn secondary" id="clearCustomerFormBtn" data-translate="clearFormBtn">➕ جديد</button>
            </div>
        </div>
        <div id="customerLog" class="sub-tab-content">
            <h2 data-translate="savedCustomers">العملاء المحفوظون</h2>
            <table class="log-table" id="customersLogTable">
                <thead><tr>
                    <th data-translate="customerCode">الكود</th>
                    <th data-translate="customerName">اسم العميل</th>
                    <th data-translate="phone">الهاتف</th>
                    <th data-translate="balance">الرصيد</th>
                    <th data-translate="logActions">إجراءات</th>
                </tr></thead>
                <tbody id="customersLogBody"></tbody>
            </table>
        </div>
      </div>
      
      <!-- Settings Tab -->
      <div id="settingsTab" class="tab-content">
        <h1 data-translate="settingsTab">الإعدادات والبيانات</h1>
        <div class="form-section">
            <h2 data-translate="companySection">بيانات الشركة</h2>
            <p class="small" data-translate="companySectionHint">هذه البيانات ستظهر في أعلى الفواتير والسندات المطبوعة.</p>
            <div class="row">
                <div class="col"><label for="settingSellerName" data-translate="sellerName">اسم الشركة</label><input id="settingSellerName" type="text"></div>
                <div class="col"><label for="settingSellerTaxNum" data-translate="sellerTaxNumber">الرقم الضريبي</label><input id="settingSellerTaxNum" type="text"></div>
            </div>
            <div class="row" style="margin-top:8px">
                <div class="col"><label for="settingSellerPhone" data-translate="phone">الهاتف</label><input id="settingSellerPhone" type="text"></div>
                <div class="col"><label for="settingSellerAddress" data-translate="sellerAddress">العنوان</label><input id="settingSellerAddress" type="text"></div>
            </div>
            <div class="actions" style="margin-top: 16px;">
                <button class="btn success" id="saveSettingsBtn" data-translate="saveSettingsBtn">💾 حفظ الإعدادات</button>
            </div>
        </div>
        <div class="form-section">
            <h2 data-translate="databaseManagement">إدارة قاعدة البيانات</h2>
            <p class="small" data-translate="databaseManagementHint">يمكنك أخذ نسخة احتياطية من كل بياناتك في ملف، أو استعادة البيانات من نسخة سابقة. البيانات تحفظ تلقائياً في المتصفح.</p>
            <div class="actions">
                <button class="btn" id="exportAllBtn" data-translate="exportAllBtn">💾 تصدير نسخة احتياطية</button>
                <div>
                    <label for="importAllFile" class="btn secondary" data-translate="importAllBtn">📂 استعادة من ملف</label>
                    <input type="file" id="importAllFile" accept=".xlsx, .xls" style="display:none;">
                </div>
                <button class="btn danger" id="clearAllDataBtn" data-translate="clearAllDataBtn">🗑️ مسح كل البيانات (خطر)</button>
            </div>
        </div>
      </div>
      
      <!-- Single, global datalists to prevent duplicate ID errors -->
      <datalist id="customersDatalist"></datalist>
      <datalist id="itemsDatalist"></datalist>
    </div>

    <!-- Preview Areas -->
    <div class="preview invoice-preview" id="invoicePreview">
        <div class="inv-header">
            <div class="seller-block">
                <h2 id="previewSellerName"></h2>
                <div id="previewSellerInfo" class="small"></div>
            </div>
            <div class="qr-block"><div id="qrContainer"></div><div class="small" style="margin-top:6px" data-translate="qrScan">امسح QR للتحقق</div></div>
        </div>
        <h1 class="invoice-title" id="invoiceTitle"></h1>
        <div id="previewClient" style="margin-top:20px; background: #f9f9f9; padding: 12px; border-radius: 6px;" class="preview-client-details"></div>
        <div style="margin-top:20px; border-top:1px solid #eee; padding-top:10px; display:flex; justify-content: space-between;">
            <div><div class="small" data-translate="previewInvoiceNo">فاتورة رقم:</div><div id="previewInvoiceNo" style="font-weight:700"></div></div>
            <div><div class="small" data-translate="previewDate">التاريخ:</div><div id="previewDate" style="font-weight:700"></div></div>
        </div>
        <div id="previewItems" style="margin-top:20px"></div>
        <div id="previewTotals" style="margin-top:20px; padding-top:10px; border-top: 1px solid #eee;"></div>
        <footer class="small" style="text-align:center; margin-top: 20px;" data-translate="thankYou">شكرا لكم</footer>
    </div>
    <div class="preview receipt-preview" id="receiptPreview">
        <div class="receipt-header" style="text-align:center; margin-bottom: 20px;">
            <h2 id="receiptPreviewSellerName"></h2>
            <div class="small" id="receiptPreviewSellerInfo"></div>
        </div>
        <h1 style="text-align:center; font-size: 1.2em; border-bottom: 1px solid #333; padding-bottom: 5px; margin-bottom: 15px;" data-translate="receiptVoucherTitle">سند تحصيل</h1>
        <table style="width:100%; border-collapse:collapse; font-size: 1em;">
            <tbody style="text-align: right;">
                <tr><td style="font-weight:bold; padding:4px;" data-translate="previewReceiptNumber">رقم السند:</td><td id="receiptPreviewNumber" style="padding:4px;"></td></tr>
                <tr><td style="font-weight:bold; padding:4px;" data-translate="previewDate">التاريخ:</td><td id="receiptPreviewDate" style="padding:4px;"></td></tr>
                <tr><td style="font-weight:bold; padding:4px;" data-translate="previewReceivedFrom">استلمنا من السيد/السادة:</td><td id="receiptPreviewCustomer" style="padding:4px;"></td></tr>
                <tr><td style="font-weight:bold; padding:4px;" data-translate="previewAmount">مبلغ وقدره:</td><td id="receiptPreviewAmount" style="padding:4px;"></td></tr>
                <tr><td style="font-weight:bold; padding:4px;" data-translate="previewFor">وذلك عن:</td><td id="receiptPreviewDesc" style="padding:4px;"></td></tr>
                <tr><td style="font-weight:bold; padding:4px;" data-translate="previewPaymentMethod">طريقة الدفع:</td><td id="receiptPreviewPayment" style="padding:4px;"></td></tr>
            </tbody>
        </table>
        <div style="margin-top: 40px; display: flex; justify-content: space-between; font-size: 0.9em;">
            <div><strong data-translate="signatureReceiver">المستلم: ....................</strong></div>
            <div><strong data-translate="signatureStamp">الختم:</strong></div>
        </div>
    </div>
    <div class="statement-preview" id="statementPreview">
        <div class="statement-header" style="text-align:center; margin-bottom: 20px;">
            <h2 id="statementSellerName"></h2>
            <div class="small" id="statementSellerInfo"></div>
            <h1 style="margin-top: 20px;" data-translate="accountStatementTitle">كشف حساب عميل</h1>
        </div>
        <div id="statementClientInfo" style="margin-bottom: 20px; padding: 10px; border: 1px solid #eee; border-radius: 6px;"></div>
        <table class="log-table" id="statementTable">
            <thead>
                <tr>
                    <th data-translate="logDate">التاريخ</th>
                    <th data-translate="statementTransaction">الحركة</th>
                    <th data-translate="statementDebit">مدين</th>
                    <th data-translate="statementCredit">دائن</th>
                    <th data-translate="balance">الرصيد</th>
                </tr>
            </thead>
            <tbody id="statementTableBody"></tbody>
        </table>
        <div id="statementSummary" style="margin-top: 20px; padding-top: 10px; border-top: 1px solid #eee; text-align: left;"></div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    
    // --- NEW: Authentication Check ---
    const loggedInUser = sessionStorage.getItem('loggedInUser');
    if (!loggedInUser) {
        // IMPORTANT: Make sure you have a 'login.html' file in the same directory
        window.location.href = 'login.html'; 
        return; // Stop script execution
    }

    // --- DBs and State ---
    let invoicesDB, receiptsDB, itemsDB, customersDB, sellerInfo;
    let currentLang = 'ar';
    let editingInvoiceId = null, editingReceiptId = null, editingItemId = null, editingCustomerId = null;
    const defaultSellerInfo = { name: "شركتي", taxNumber: "123456789012345", address: "الرياض، السعودية", phone: "0501234567" };

    // --- Helper Functions ---
    const $ = id => document.getElementById(id);
    const toLocalDateTime = (date = new Date()) => new Date(date.getTime() - (date.getTimezoneOffset() * 60000)).toISOString().slice(0, 16);
    const formatDate = (dateStr) => {
        if (!dateStr) return '';
        const date = new Date(dateStr);
        return `${String(date.getDate()).padStart(2, '0')}-${String(date.getMonth() + 1).padStart(2, '0')}-${date.getFullYear()}`;
    };
    const escapeHTML = s => (s || '').toString().replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m]);

    // --- MODIFIED: User-Specific Local Storage Functions ---
    function saveAllDataToLocalStorage() {
        try {
            const dataToSave = { invoicesDB, receiptsDB, itemsDB, customersDB, sellerInfo };
            // Save data under a user-specific key
            localStorage.setItem(`accountingData_${loggedInUser}`, JSON.stringify(dataToSave));
        } catch (e) {
            console.error("Error saving to localStorage", e);
            alert("Could not save data automatically. Your browser might be in private mode or storage is full.");
        }
    }

    function loadAllDataFromLocalStorage() {
        // Load data from the user-specific key
        const savedData = localStorage.getItem(`accountingData_${loggedInUser}`);
        if (savedData) {
            try {
                const data = JSON.parse(savedData);
                invoicesDB = data.invoicesDB || [];
                receiptsDB = data.receiptsDB || [];
                itemsDB = data.itemsDB || [];
                customersDB = data.customersDB || [];
                sellerInfo = data.sellerInfo || defaultSellerInfo;
            } catch (e) {
                console.error("Error parsing data from localStorage", e);
                initializeAppWithDefaults();
            }
        } else {
            // If no data for this user, start with fresh defaults
            initializeAppWithDefaults();
        }
    }

    function initializeAppWithDefaults(){
        invoicesDB = []; receiptsDB = []; itemsDB = []; customersDB = [];
        sellerInfo = defaultSellerInfo;
    }

    // --- Translations Object (with added logout and modified prompts) ---
    const translations = {
      en: {
        pageTitle: "Invoicing & Collection System", logoutBtn: "Logout", invoiceTab: "Tax Invoice", receiptTab: "Receipt Voucher", itemsTab: "Items", customersTab: "Customers", settingsTab: "Data & Settings", createInvoiceSubTab: "Create Invoice", invoiceLogSubTab: "Invoice Log", createCustomerSubTab: "Create Customer", customerLogSubTab: "Customer Log", createItemSubTab: "Create Item", itemLogSubTab: "Item Log", companySection: "Company Information", sellerName: "Company Name", sellerTaxNumber: "Tax Number", sellerPhone: "Company Phone", sellerAddress: "Company Address", companySectionHint: "This information will appear on printed invoices and receipts.", invoiceAndCustomerData: "Invoice & Customer Data", invoiceNumber: "Invoice Number", invoiceDate: "Invoice Date", customerName: "Customer Name", customerNamePlaceholder: "Select or type customer name", customerTaxNumber: "Customer Tax Number", items: "Items", itemDescription: "Description", itemQty: "Qty", itemUnitPrice: "Unit Price", itemTotal: "Total", itemAction: "Action", addItemBtn: "➕ Add Item", subTotalLabel: "Subtotal:", vatTotalLabel: "VAT (15%):", grandTotalLabel: "Grand Total:", newInvoiceBtn: "➕ New", generateBtn: "💾 Save", printBtn: "🖨️ Print", invoiceLogTitle: "Invoices Log", logInvoiceNumber: "Invoice #", logDate: "Date", logCustomer: "Customer", logTotal: "Total", createReceiptSubTab: "Create Receipt", receiptLogSubTab: "Receipt Log", salesReceiptVoucher: "Sales Receipt Voucher", voucherData: "Voucher Data", receiptNumber: "Voucher No.", receiptDate: "Voucher Date", customerAndCollectionData: "Customer & Collection Data", receiptCustomerName: "Customer Name", receiptCustomerNamePlaceholder: "Select customer", amountReceived: "Amount Received", paymentMethod: "Payment Method", paymentCash: "Cash", paymentBank: "Bank Transfer", paymentCard: "Credit Card", description: "Description", receiptDescriptionLabel: "Collection Description", receiptDescriptionPlaceholder: "e.g., Payment for invoice #INV-0001", newReceiptBtn: "➕ New", saveReceiptBtn: "💾 Save Voucher", printReceiptBtn: "🖨️ Print Voucher", receiptLogTitle: "Receipts Log", logReceiptNumber: "Voucher #", logAmount: "Amount", qrScan: "Scan QR for verification", previewInvoiceNo: "Invoice No:", previewDate: "Date:", thankYou: "Thank you", receiptVoucherTitle: "Receipt Voucher", previewReceiptNumber: "Voucher No.:", previewReceivedFrom: "Received from Mr./M/s:", previewAmount: "The sum of:", previewFor: "In settlement of:", previewPaymentMethod: "Payment Method:", signatureReceiver: "Receiver: ....................", signatureStamp: "Stamp:", invoiceTo: "Bill To:",
        itemsManagement: "Items Management", addNewItem: "Add/Edit Item", itemName: "Item Name/Description", itemPrice: "Unit Price", saveItemBtn: "💾 Save Item", updateItemBtn: "💾 Update Item", savedItems: "Saved Items", qtySold: "Qty Sold", customersManagement: "Customers Management", addNewCustomer: "Add/Edit Customer", logActions: "Actions", editBtn: "Edit", deleteBtn: "Delete", confirmDelete: "Are you sure you want to delete this record? This action cannot be undone.", updateBtnText: "💾 Update Invoice", updateReceiptBtnText: "💾 Update Voucher",
        customerCode: "Customer Code", balance: "Balance", printStatement: "Statement", crNumber: "C.R. Number", nationalId: "National ID", phone: "Phone", nationalAddress: "National Address", city: "City", district: "District", street: "Street", postalCode: "Postal Code", buildingNumber: "Building No.", additionalNumber: "Additional No.", saveCustomerBtn: "💾 Save Customer", updateCustomerBtn: "💾 Update Customer", clearFormBtn: "➕ New", accountStatementTitle: "Customer Account Statement", statementTransaction: "Transaction", statementDebit: "Debit", statementCredit: "Credit", balanceDue: "Balance Due:", closingBalance: "Closing Balance", savedCustomers: "Saved Customers",
        saveSettingsBtn: "💾 Save Settings", databaseManagement: "Database Management", databaseManagementHint: "You can export a backup of your data, or restore from a file. Data is saved automatically in your browser.", exportAllBtn: "💾 Export Backup", importAllBtn: "📂 Restore from File", importSuccess: "Database restored successfully!", importError: "Failed to restore database. Please check the file format.", simplifiedTaxInvoice: "Simplified Tax Invoice",
        clearAllDataBtn: "🗑️ Clear All Data (Danger)", confirmClearAll: "ARE YOU SURE? All data for this user will be permanently deleted. This action cannot be undone."
      },
      ar: {
        pageTitle: "نظام الفواتير والسندات", logoutBtn: "تسجيل الخروج", invoiceTab: "فاتورة ضريبية", receiptTab: "سند تحصيل", itemsTab: "الأصناف", customersTab: "العملاء", settingsTab: "الإعدادات والبيانات", createInvoiceSubTab: "إنشاء فاتورة", invoiceLogSubTab: "سجل الفواتير", createCustomerSubTab: "إنشاء عميل", customerLogSubTab: "سجل العملاء", createItemSubTab: "إنشاء صنف", itemLogSubTab: "سجل الأصناف", companySection: "بيانات الشركة", sellerName: "اسم الشركة", sellerTaxNumber: "الرقم الضريبي", sellerPhone: "هاتف الشركة", sellerAddress: "عنوان الشركة", companySectionHint: "هذه البيانات ستظهر في أعلى الفواتير والسندات المطبوعة.", invoiceAndCustomerData: "بيانات الفاتورة والعميل", invoiceNumber: "رقم الفاتورة", invoiceDate: "تاريخ الفاتورة", customerName: "اسم العميل", customerNamePlaceholder: "اختر أو اكتب اسم العميل", customerTaxNumber: "الرقم الضريبي للعميل", items: "الأصناف", itemDescription: "الوصف", itemQty: "الكمية", itemUnitPrice: "سعر الوحدة", itemTotal: "الإجمالي", itemAction: "إجراء", addItemBtn: "➕ إضافة صنف", subTotalLabel: "الإجمالي قبل الضريبة:", vatTotalLabel: "قيمة الضريبة (15%):", grandTotalLabel: "الإجمالي الكلي:", newInvoiceBtn: "➕ جديد", generateBtn: "💾 حفظ", printBtn: "🖨️ طباعة", invoiceLogTitle: "سجل الفواتير", logInvoiceNumber: "رقم الفاتورة", logDate: "التاريخ", logCustomer: "العميل", logTotal: "الإجمالي", createReceiptSubTab: "إنشاء سند", receiptLogSubTab: "سجل السندات", salesReceiptVoucher: "سند تحصيل مبيعات", voucherData: "بيانات السند", receiptNumber: "رقم السند", receiptDate: "تاريخ السند", customerAndCollectionData: "بيانات العميل والتحصيل", receiptCustomerName: "اسم العميل", receiptCustomerNamePlaceholder: "اختر العميل", amountReceived: "المبلغ المستلم", paymentMethod: "طريقة الدفع", paymentCash: "نقدي", paymentBank: "تحويل بنكي", paymentCard: "بطاقة ائتمان", description: "الوصف", receiptDescriptionLabel: "وصف عملية التحصيل", receiptDescriptionPlaceholder: "مثال: دفعة من فاتورة رقم INV-0001", newReceiptBtn: "➕ جديد", saveReceiptBtn: "💾 حفظ السند", printReceiptBtn: "🖨️ طباعة السند", receiptLogTitle: "سجل سندات التحصيل", logReceiptNumber: "رقم السند", logAmount: "المبلغ", qrScan: "امسح QR للتحقق", previewInvoiceNo: "فاتورة رقم:", previewDate: "التاريخ:", thankYou: "شكرا لكم", receiptVoucherTitle: "سند تحصيل", previewReceiptNumber: "رقم السند:", previewReceivedFrom: "استلمنا من السيد/السادة:", previewAmount: "مبلغ وقدره:", previewFor: "وذلك عن:", previewPaymentMethod: "طريقة الدفع:", signatureReceiver: "المستلم: ....................", signatureStamp: "الختم:", invoiceTo: "فاتورة إلى:",
        itemsManagement: "إدارة الأصناف", addNewItem: "إضافة/تعديل صنف", itemName: "اسم/وصف الصنف", itemPrice: "سعر الوحدة", saveItemBtn: "💾 حفظ الصنف", updateItemBtn: "💾 تحديث الصنف", savedItems: "الأصناف المحفوظة", qtySold: "الكمية المباعة", customersManagement: "إدارة العملاء", addNewCustomer: "إضافة/تعديل عميل", logActions: "إجراءات", editBtn: "تعديل", deleteBtn: "حذف", confirmDelete: "هل أنت متأكد من حذف هذا السجل؟ لا يمكن التراجع عن هذا الإجراء.", updateBtnText: "💾 تحديث الفاتورة", updateReceiptBtnText: "💾 تحديث السند",
        customerCode: "كود العميل", balance: "الرصيد", printStatement: "كشف حساب", crNumber: "رقم السجل التجاري", nationalId: "رقم الهوية", phone: "رقم الهاتف", nationalAddress: "العنوان الوطني", city: "المدينة", district: "الحي", street: "الشارع", postalCode: "الرمز البريدي", buildingNumber: "رقم المبنى", additionalNumber: "الرقم الإضافي", saveCustomerBtn: "💾 حفظ العميل", updateCustomerBtn: "💾 تحديث العميل", clearFormBtn: "➕ جديد", accountStatementTitle: "كشف حساب عميل", statementTransaction: "الحركة", statementDebit: "مدين", statementCredit: "دائن", balanceDue: "الرصيد المستحق:", closingBalance: "الرصيد الختامي", savedCustomers: "العملاء المحفوظون",
        saveSettingsBtn: "💾 حفظ الإعدادات", databaseManagement: "إدارة قاعدة البيانات", databaseManagementHint: "يمكنك أخذ نسخة احتياطية من كل بياناتك في ملف، أو استعادة البيانات من نسخة سابقة. البيانات تحفظ تلقائياً في المتصفح.", exportAllBtn: "💾 تصدير نسخة احتياطية", importAllBtn: "📂 استعادة من ملف", importSuccess: "تم استعادة قاعدة البيانات بنجاح!", importError: "فشل استعادة قاعدة البيانات. الرجاء التأكد من صيغة الملف.", simplifiedTaxInvoice: "فاتورة ضريبية مبسطة",
        clearAllDataBtn: "🗑️ مسح كل البيانات (خطر)", confirmClearAll: "هل أنت متأكد تماماً؟ سيتم حذف كل بيانات هذا المستخدم بشكل نهائي. لا يمكن التراجع عن هذا الإجراء."
      }
    };
    
    // --- Efficient Language Switcher ---
    function setLanguage(lang) {
        currentLang = lang;
        document.documentElement.lang = lang;
        document.documentElement.dir = lang === 'ar' ? 'rtl' : 'ltr';
        $('langToggleBtn').innerText = lang === 'ar' ? 'English' : 'العربية';
        document.querySelectorAll('[data-translate]').forEach(el => {
            const key = el.getAttribute('data-translate');
            if (translations[lang][key]) {
                 if (el.tagName === 'P' && el.classList.contains('small')) {
                    el.innerText = translations[lang][key] || el.innerText;
                } else {
                    el.innerText = translations[lang][key];
                }
            }
        });
        document.querySelectorAll('[data-translate-placeholder]').forEach(el => {
            const key = el.getAttribute('data-translate-placeholder');
            if (translations[lang][key]) el.placeholder = translations[lang][key];
        });
        updateMainActionButtonsText();
    }
    
    function updateMainActionButtonsText() {
        const t = translations[currentLang];
        $('generateBtn').innerText = editingInvoiceId ? t.updateBtnText : t.generateBtn;
        $('saveReceiptBtn').innerText = editingReceiptId ? t.updateReceiptBtnText : t.saveReceiptBtn;
        $('saveItemBtn').innerText = editingItemId ? t.updateItemBtn : t.saveItemBtn;
        $('saveCustomerBtn').innerText = editingCustomerId ? t.updateCustomerBtn : t.saveCustomerBtn;
    }

    // --- Tab Switching ---
    function setupTabSwitching() {
        document.querySelectorAll('.tab-btn, .sub-tab-btn').forEach(button => {
            button.addEventListener('click', () => {
                const isMainTab = button.classList.contains('tab-btn');
                if(isMainTab){
                    document.querySelectorAll('.preview, .statement-preview').forEach(p => p.style.display = 'none');
                }
                const parentId = button.dataset.parent;
                const navSelector = isMainTab ? '.tabs-nav' : `div[id="${parentId}"] .sub-tabs-nav`;
                const contentSelector = isMainTab ? '.tab-content' : `div[id="${parentId}"] .sub-tab-content`;
                
                document.querySelectorAll(`${navSelector} > button`).forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');
                
                document.querySelectorAll(contentSelector).forEach(content => content.classList.remove('active'));
                $(button.dataset.tab).classList.add('active');
            });
        });
    }

    // --- Calculation and Rendering ---
    function calculateCustomerBalance(customerCode) {
        const totalInvoices = invoicesDB.filter(inv => inv.customerCode === customerCode).reduce((sum, inv) => sum + parseFloat(inv.grandTotal), 0);
        const totalReceipts = receiptsDB.filter(rec => rec.customerCode === customerCode).reduce((sum, rec) => sum + parseFloat(rec.amount), 0);
        return (totalInvoices - totalReceipts).toFixed(2);
    }
    function calculateItemSales(itemName) {
        return invoicesDB.reduce((totalQty, inv) => {
            const itemInInvoice = inv.items.find(item => item.description === itemName);
            return totalQty + (itemInInvoice ? parseFloat(itemInInvoice.quantity || 0) : 0);
        }, 0);
    }
    
    function renderAllLogs() {
        renderCustomersLog();
        renderInvoiceLog();
        renderReceiptLog();
        renderItemsLog();
    }
    
    // --- Data Management (Customers, Items, Invoices, Receipts) ---
    function renderCustomersLog() {
        const logBody = $('customersLogBody');
        logBody.innerHTML = '';
        const t = translations[currentLang];
        customersDB.forEach((cust) => {
            const balance = calculateCustomerBalance(cust.id);
            const balanceColor = parseFloat(balance) >= 0 ? 'blue' : 'red';
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${escapeHTML(cust.id)}</td>
                <td>${escapeHTML(cust.name)}</td>
                <td>${escapeHTML(cust.phone)}</td>
                <td style="color:${balanceColor}; font-weight:bold;">${balance}</td>
                <td class="actions">
                    <button class="btn warning small-action edit-btn" data-type="customer" data-id="${cust.id}">${t.editBtn}</button>
                    <button class="btn danger small-action delete-btn" data-type="customer" data-id="${cust.id}">${t.deleteBtn}</button>
                    <button class="btn info small-action statement-btn" data-type="customer" data-id="${cust.id}">${t.printStatement}</button>
                </td>`;
            logBody.appendChild(tr);
        });
        populateCustomersDatalist();
    }

    function populateCustomersDatalist() {
        const datalist = $('customersDatalist');
        if(!datalist) return;
        datalist.innerHTML = '';
        customersDB.forEach(cust => {
            datalist.innerHTML += `<option value="${escapeHTML(cust.name)}" data-code="${escapeHTML(cust.id)}"></option>`;
        });
    }

    function clearCustomerForm() {
        editingCustomerId = null;
        const fields = ['custCode', 'custName', 'custTaxNumber', 'custCrNumber', 'custNationalId', 'custPhone', 'custCity', 'custDistrict', 'custStreet', 'custPostalCode', 'custBuildingNumber', 'custAdditionalNumber'];
        fields.forEach(f => $(f).value = '');
        $('custCode').disabled = false;
        updateMainActionButtonsText();
    }
    
    function saveCustomer() {
        const id = $('custCode').value.trim();
        if (!id) { alert(translations[currentLang].customerCode + " is required."); return; }
        if (editingCustomerId === null && customersDB.some(c => c.id === id)) {
            alert("Customer code already exists.");
            return;
        }
        const customerData = {
            id, name: $('custName').value.trim(), taxNumber: $('custTaxNumber').value.trim(), crNumber: $('custCrNumber').value.trim(), nationalId: $('custNationalId').value.trim(), phone: $('custPhone').value.trim(),
            address: { city: $('custCity').value.trim(), district: $('custDistrict').value.trim(), street: $('custStreet').value.trim(), postalCode: $('custPostalCode').value.trim(), buildingNumber: $('custBuildingNumber').value.trim(), additionalNumber: $('custAdditionalNumber').value.trim() }
        };
        if (editingCustomerId !== null) {
            const index = customersDB.findIndex(c => c.id === editingCustomerId);
            if(index > -1) customersDB[index] = customerData;
        } else {
            customersDB.push(customerData);
        }
        clearCustomerForm();
        renderCustomersLog();
        saveAllDataToLocalStorage();
    }

    function renderItemsLog() {
        const logBody = $('itemsLogBody');
        logBody.innerHTML = '';
        const t = translations[currentLang];
        itemsDB.forEach((item, index) => {
            const qtySold = calculateItemSales(item.name);
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${escapeHTML(item.name)}</td>
                <td>${item.price}</td>
                <td>${qtySold}</td>
                <td class="actions">
                    <button class="btn warning small-action edit-btn" data-type="item" data-id="${index}">${t.editBtn}</button>
                    <button class="btn danger small-action delete-btn" data-type="item" data-id="${index}">${t.deleteBtn}</button>
                </td>`;
            logBody.appendChild(tr);
        });
        populateItemsDatalist();
    }

    function populateItemsDatalist() {
        const datalist = $('itemsDatalist');
        if(!datalist) return;
        datalist.innerHTML = '';
        itemsDB.forEach(item => {
            datalist.innerHTML += `<option value="${escapeHTML(item.name)}"></option>`;
        });
    }

    function clearItemForm() {
        editingItemId = null;
        $('itemName').value = '';
        $('itemPrice').value = '';
        updateMainActionButtonsText();
    }

    function saveItem() {
        const name = $('itemName').value.trim();
        const price = parseFloat($('itemPrice').value) || 0;
        if (!name) return;
        if (editingItemId !== null) {
            itemsDB[editingItemId] = { name, price };
        } else {
            itemsDB.push({ name, price });
        }
        clearItemForm();
        renderItemsLog();
        saveAllDataToLocalStorage();
    }
    
    function renderInvoiceLog() {
        const logBody = $('invoiceLogBody');
        logBody.innerHTML = '';
        const t = translations[currentLang];
        invoicesDB.forEach((inv) => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${escapeHTML(inv.invoiceNumber)}</td><td>${formatDate(inv.invoiceDate)}</td>
                <td>${escapeHTML(inv.customerName)}</td><td>${inv.grandTotal}</td>
                <td class="actions">
                    <button class="btn warning small-action edit-btn" data-type="invoice" data-id="${inv.invoiceNumber}">${t.editBtn}</button>
                    <button class="btn danger small-action delete-btn" data-type="invoice" data-id="${inv.invoiceNumber}">${t.deleteBtn}</button>
                    <button class="btn secondary small-action print-btn" data-type="invoice" data-id="${inv.invoiceNumber}">${t.printBtn}</button>
                </td>`;
            logBody.appendChild(tr);
        });
    }
    
    function clearInvoiceForm() {
        editingInvoiceId = null;
        $('invoiceNumber').value = '';
        $('invoiceDate').value = toLocalDateTime();
        $('customerName').value = '';
        $('customerTaxNumber').value = '';
        $('customerBalanceDisplay').textContent = '';
        $('itemsBody').innerHTML = '';
        addItem('', 1, 0);
        updateMainActionButtonsText();
    }

    function saveInvoice() {
        const customerName = $("customerName").value;
        const selectedOption = Array.from($('customersDatalist').options).find(opt => opt.value === customerName);
        const customerCode = selectedOption ? selectedOption.dataset.code : null;
        if (!customerCode) { alert("Please select a valid customer."); return null; }
        const invoiceNumber = $("invoiceNumber").value.trim() || `INV-${Date.now()}`;
        if (editingInvoiceId === null && invoicesDB.some(inv => inv.invoiceNumber === invoiceNumber)) {
            alert(`Invoice number ${invoiceNumber} already exists.`); return null;
        }
        const invoiceData = {
            invoiceNumber, invoiceDate: new Date($('invoiceDate').value).toISOString(), customerCode, customerName,
            subTotal: parseFloat($("subTotal").innerText).toFixed(2), vatTotal: parseFloat($("vatTotal").innerText).toFixed(2), grandTotal: parseFloat($("grandTotal").innerText).toFixed(2),
            items: Array.from($('itemsBody').querySelectorAll('tr')).map(r => ({ description: r.querySelector('.txt-desc').value, quantity: r.querySelector('.txt-qty').value, price: r.querySelector('.txt-price').value, total: r.querySelector('.cell-line-total').innerText }))
        };
        if (editingInvoiceId) {
            const index = invoicesDB.findIndex(inv => inv.invoiceNumber === editingInvoiceId);
            if (index > -1) invoicesDB[index] = invoiceData;
        } else {
            invoicesDB.push(invoiceData);
        }
        renderAllLogs();
        clearInvoiceForm();
        saveAllDataToLocalStorage();
        return invoiceData;
    }

    function renderReceiptLog() {
        const logBody = $('receiptLogBody');
        logBody.innerHTML = '';
        const t = translations[currentLang];
        receiptsDB.forEach((rec) => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${escapeHTML(rec.receiptNumber)}</td><td>${formatDate(rec.date)}</td>
                <td>${escapeHTML(rec.customerName)}</td><td>${rec.amount}</td>
                <td class="actions">
                    <button class="btn warning small-action edit-btn" data-type="receipt" data-id="${rec.receiptNumber}">${t.editBtn}</button>
                    <button class="btn danger small-action delete-btn" data-type="receipt" data-id="${rec.receiptNumber}">${t.deleteBtn}</button>
                    <button class="btn secondary small-action print-btn" data-type="receipt" data-id="${rec.receiptNumber}">${t.printBtn}</button>
                </td>`;
            logBody.appendChild(tr);
        });
    }

    function clearReceiptForm() {
        editingReceiptId = null;
        $('receiptNumber').value = '';
        $('receiptDate').value = toLocalDateTime();
        $('receiptCustomerName').value = '';
        $('amountReceived').value = '';
        $('receiptDescription').value = '';
        $('receiptCustomerBalanceDisplay').textContent = '';
        updateMainActionButtonsText();
    }
    
    function saveReceipt() {
        const customerName = $("receiptCustomerName").value;
        const selectedOption = Array.from($('customersDatalist').options).find(opt => opt.value === customerName);
        const customerCode = selectedOption ? selectedOption.dataset.code : null;
        if (!customerCode) { alert("Please select a valid customer."); return null; }
        const receiptNumber = $('receiptNumber').value.trim() || `REC-${Date.now()}`;
        if (editingReceiptId === null && receiptsDB.some(rec => rec.receiptNumber === receiptNumber)) {
            alert(`Receipt number ${receiptNumber} already exists.`); return null;
        }
        const receiptData = {
            receiptNumber, date: new Date($('receiptDate').value).toISOString(), customerCode, customerName,
            amount: parseFloat($('amountReceived').value) || 0, paymentMethod: $('paymentMethod').value, description: $('receiptDescription').value,
        };
        if (editingReceiptId) {
            const index = receiptsDB.findIndex(rec => rec.receiptNumber === editingReceiptId);
            if (index > -1) receiptsDB[index] = receiptData;
        } else {
            receiptsDB.push(receiptData);
        }
        renderAllLogs();
        clearReceiptForm();
        saveAllDataToLocalStorage();
        return receiptData;
    }

    // --- Invoice Item Management ---
    function recalcAll() {
        let subtotal = 0;
        $('itemsBody').querySelectorAll('tr').forEach(r => {
            const qty = parseFloat(r.querySelector('.txt-qty').value) || 0;
            const price = parseFloat(r.querySelector('.txt-price').value) || 0;
            const lineTotal = qty * price;
            r.querySelector('.cell-line-total').innerText = lineTotal.toFixed(2);
            subtotal += lineTotal;
        });
        const vat = subtotal * 0.15;
        const total = subtotal + vat;
        $("subTotal").innerText = subtotal.toFixed(2);
        $("vatTotal").innerText = vat.toFixed(2);
        $("grandTotal").innerText = total.toFixed(2);
    }
    function addItem(desc = '', qty = 1, price = 0) {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td><input class="txt-desc" type="text" value="${escapeHTML(desc)}" list="itemsDatalist"></td>
            <td><input class="txt-qty" type="number" min="0" step="any" value="${qty}"></td>
            <td><input class="txt-price" type="number" min="0" step="any" value="${price}"></td>
            <td class="cell-line-total">0.00</td>
            <td><button class="btn danger btn-del no-print">${translations[currentLang].deleteBtn}</button></td>`;
        $('itemsBody').appendChild(tr);
        const descInput = tr.querySelector('.txt-desc');
        descInput.addEventListener('input', () => {
            const selectedItem = itemsDB.find(i => i.name === descInput.value);
            if (selectedItem) { tr.querySelector('.txt-price').value = selectedItem.price; recalcAll(); }
        });
        tr.querySelectorAll('input').forEach(inp => inp.addEventListener('input', recalcAll));
        tr.querySelector('.btn-del').addEventListener('click', () => { tr.remove(); recalcAll(); });
        recalcAll();
    }
    
    // --- Previews and Printing ---
    function zatcaDataToBase64(sellerName, sellerTaxNumber, timestamp, invoiceTotal, vatTotal) {
        const toTlv = (tag, value) => {
            const valBytes = new TextEncoder().encode(String(value));
            const tlv = new Uint8Array(2 + valBytes.length);
            tlv[0] = tag; tlv[1] = valBytes.length; tlv.set(valBytes, 2);
            return tlv;
        };
        const parts = [toTlv(1, sellerName), toTlv(2, sellerTaxNumber), toTlv(3, timestamp), toTlv(4, String(invoiceTotal)), toTlv(5, String(vatTotal))];
        const combined = new Uint8Array(parts.reduce((acc, p) => acc + p.length, 0));
        let offset = 0;
        parts.forEach(p => { combined.set(p, offset); offset += p.length; });
        return btoa(String.fromCharCode.apply(null, combined));
    }

    function generateInvoicePreview(invoiceData) {
        if (!invoiceData) return;
        const t = translations[currentLang];
        const customer = customersDB.find(c => c.id === invoiceData.customerCode);
        $('previewSellerName').innerText = sellerInfo.name;
        $('previewSellerInfo').innerHTML = `${sellerInfo.address}<br>${t.phone}: ${sellerInfo.phone}<br>${t.sellerTaxNumber}: ${sellerInfo.taxNumber}`;
        $('invoiceTitle').innerText = t.simplifiedTaxInvoice;
        let clientHtml = '';
        if (customer) {
            const addr = customer.address || {};
            const fullAddress = `${addr.buildingNumber} ${addr.street}, ${addr.district}, ${addr.city} ${addr.postalCode}`;
            clientHtml = `<div class="detail-row"><div class="detail-label">${t.customerName}:</div><div>${escapeHTML(customer.name)}</div></div>` +
                         `<div class="detail-row"><div class="detail-label">${t.customerTaxNumber}:</div><div>${escapeHTML(customer.taxNumber)}</div></div>` +
                         `<div class="detail-row"><div class="detail-label">${t.crNumber}:</div><div>${escapeHTML(customer.crNumber)}</div></div>` +
                         `<div class="detail-row"><div class="detail-label">${t.phone}:</div><div>${escapeHTML(customer.phone)}</div></div>` +
                         `<div class="detail-row"><div class="detail-label">${t.nationalAddress}:</div><div>${escapeHTML(fullAddress)}</div></div>`;
        }
        $('previewClient').innerHTML = clientHtml;
        $('previewInvoiceNo').innerText = invoiceData.invoiceNumber;
        $('previewDate').innerText = formatDate(invoiceData.invoiceDate);
        let itemsHtml = `<table class="items-table" style="font-size:14px; text-align:center;"><thead><tr><th>${t.itemDescription}</th><th>${t.itemQty}</th><th>${t.itemUnitPrice}</th><th>${t.itemTotal}</th></tr></thead><tbody>`;
        invoiceData.items.forEach(item => { itemsHtml += `<tr><td>${escapeHTML(item.description)}</td><td>${escapeHTML(item.quantity)}</td><td>${parseFloat(item.price||0).toFixed(2)}</td><td>${parseFloat(item.total||0).toFixed(2)}</td></tr>`; });
        $('previewItems').innerHTML = itemsHtml + '</tbody></table>';
        $('previewTotals').innerHTML = `<table style="width:50%;margin-${currentLang==='ar'?'right':'left'}:auto;margin-${currentLang==='ar'?'left':'right'}:0;"><tr><td>${t.subTotalLabel}</td><td>${invoiceData.subTotal} SAR</td></tr><tr><td>${t.vatTotalLabel}</td><td>${invoiceData.vatTotal} SAR</td></tr><tr><td><b>${t.grandTotalLabel}</b></td><td><b>${invoiceData.grandTotal} SAR</b></td></tr></table>`;
        const tlvBase64 = zatcaDataToBase64(sellerInfo.name, sellerInfo.taxNumber, invoiceData.invoiceDate, invoiceData.grandTotal, invoiceData.vatTotal);
        $('qrContainer').innerHTML = '';
        new QRCode($("qrContainer"), { text: tlvBase64, width: 140, height: 140 });
        document.querySelectorAll('.preview, .statement-preview').forEach(p => p.style.display = 'none');
        $('invoicePreview').style.display = 'block';
    }

    function generateReceiptPreview(receiptData) {
        if (!receiptData) return;
        const t = translations[currentLang];
        $('receiptPreviewSellerName').innerText = sellerInfo.name;
        $('receiptPreviewSellerInfo').innerText = `${sellerInfo.address} | ${sellerInfo.phone}`;
        $('receiptPreviewNumber').innerText = receiptData.receiptNumber;
        $('receiptPreviewDate').innerText = formatDate(receiptData.date);
        $('receiptPreviewCustomer').innerText = receiptData.customerName;
        $('receiptPreviewAmount').innerText = `${parseFloat(receiptData.amount).toFixed(2)} SAR`;
        $('receiptPreviewDesc').innerText = receiptData.description;
        $('receiptPreviewPayment').innerText = t[Object.keys(t).find(k => t[k] === receiptData.paymentMethod)] || receiptData.paymentMethod;
        document.querySelectorAll('.preview, .statement-preview').forEach(p => p.style.display = 'none');
        $('receiptPreview').style.display = 'block';
    }

    function generateStatementPreview(customerCode) {
        const customer = customersDB.find(c => c.id === customerCode);
        if (!customer) return;
        const t = translations[currentLang];
        $('statementSellerName').innerText = sellerInfo.name;
        $('statementSellerInfo').innerText = `${sellerInfo.address} | ${sellerInfo.phone}`;
        $('statementClientInfo').innerHTML = `<strong>${t.customerName}:</strong> ${customer.name} | <strong>${t.customerCode}:</strong> ${customer.id}`;
        const customerInvoices = invoicesDB.filter(inv => inv.customerCode === customerCode).map(inv => ({ date: new Date(inv.invoiceDate), desc: `${t.logInvoiceNumber} ${inv.invoiceNumber}`, debit: parseFloat(inv.grandTotal), credit: 0 }));
        const customerReceipts = receiptsDB.filter(rec => rec.customerCode === customerCode).map(rec => ({ date: new Date(rec.date), desc: `${t.logReceiptNumber} ${rec.receiptNumber}`, debit: 0, credit: parseFloat(rec.amount) }));
        const transactions = [...customerInvoices, ...customerReceipts].sort((a,b) => a.date - b.date);
        const tableBody = $('statementTableBody');
        tableBody.innerHTML = '';
        let runningBalance = 0;
        transactions.forEach(tx => {
            runningBalance += tx.debit - tx.credit;
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${formatDate(tx.date)}</td><td>${escapeHTML(tx.desc)}</td><td>${tx.debit.toFixed(2)}</td><td>${tx.credit.toFixed(2)}</td><td>${runningBalance.toFixed(2)}</td>`;
            tableBody.appendChild(tr);
        });
        $('statementSummary').innerHTML = `<strong>${t.closingBalance}: ${runningBalance.toFixed(2)} SAR</strong>`;
        document.querySelectorAll('.preview, .statement-preview').forEach(p => p.style.display = 'none');
        $('statementPreview').style.display = 'block';
    }

    function handleCustomerSelection(e, balanceDisplayId) {
        const input = e.target;
        const balanceDisplay = $(balanceDisplayId);
        balanceDisplay.textContent = '';
        const selectedOption = Array.from(document.getElementById('customersDatalist').options).find(opt => opt.value === input.value);
        if (selectedOption) {
            const customerCode = selectedOption.dataset.code;
            const customer = customersDB.find(c => c.id === customerCode);
            if (customer) {
                if (input.id === 'customerName') { $('customerTaxNumber').value = customer.taxNumber; }
                const balance = calculateCustomerBalance(customer.id);
                balanceDisplay.textContent = `${translations[currentLang].balance}: ${balance}`;
            }
        }
    }
    
    // --- Settings and Data Backup/Restore ---
    function loadSettingsForm() {
        $('settingSellerName').value = sellerInfo.name;
        $('settingSellerTaxNum').value = sellerInfo.taxNumber;
        $('settingSellerAddress').value = sellerInfo.address;
        $('settingSellerPhone').value = sellerInfo.phone;
    }
    function saveSettings() {
        sellerInfo.name = $('settingSellerName').value;
        sellerInfo.taxNumber = $('settingSellerTaxNum').value;
        sellerInfo.address = $('settingSellerAddress').value;
        sellerInfo.phone = $('settingSellerPhone').value;
        saveAllDataToLocalStorage();
        alert("تم حفظ إعدادات الشركة.");
    }

    function exportAllData() {
        const workbook = XLSX.utils.book_new();
        const flattenedCustomers = customersDB.map(c => ({ ...(c.address || {}), ...c, address: undefined }));
        const invoicesForExport = invoicesDB.map(invoice => ({ ...invoice, items: JSON.stringify(invoice.items || []) }));
        XLSX.utils.book_append_sheet(workbook, XLSX.utils.json_to_sheet(flattenedCustomers), "Customers");
        XLSX.utils.book_append_sheet(workbook, XLSX.utils.json_to_sheet(itemsDB), "Items");
        XLSX.utils.book_append_sheet(workbook, XLSX.utils.json_to_sheet(invoicesForExport), "Invoices");
        XLSX.utils.book_append_sheet(workbook, XLSX.utils.json_to_sheet(receiptsDB), "Receipts");
        XLSX.utils.book_append_sheet(workbook, XLSX.utils.json_to_sheet([sellerInfo]), "Settings");
        XLSX.writeFile(workbook, `backup-${loggedInUser}-${new Date().toISOString().slice(0,10)}.xlsx`);
    }

    function importAllData(event) {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: "array" });
                const safeSheetToJSON = (sheetName) => workbook.Sheets[sheetName] ? XLSX.utils.sheet_to_json(workbook.Sheets[sheetName]) : [];

                const importedCustomers = safeSheetToJSON("Customers").map(c => ({ id: c.id, name: c.name, taxNumber: c.taxNumber, crNumber: c.crNumber, nationalId: c.nationalId, phone: c.phone, address: { city: c.city, district: c.district, street: c.street, postalCode: c.postalCode, buildingNumber: c.buildingNumber, additionalNumber: c.additionalNumber }}));
                const importedItems = safeSheetToJSON("Items");
                const importedReceipts = safeSheetToJSON("Receipts");
                const importedSettings = safeSheetToJSON("Settings");
                const importedInvoices = safeSheetToJSON("Invoices").map(inv => ({ ...inv, items: typeof inv.items === 'string' ? JSON.parse(inv.items) : (inv.items || []) }));

                customersDB = importedCustomers;
                itemsDB = importedItems;
                invoicesDB = importedInvoices;
                receiptsDB = importedReceipts;
                if (importedSettings.length > 0) sellerInfo = importedSettings[0];
                
                saveAllDataToLocalStorage();
                alert(translations[currentLang].importSuccess);
                location.reload(); 
            } catch (err) {
                console.error(err);
                alert(translations[currentLang].importError);
            }
        };
        reader.readAsArrayBuffer(file);
        event.target.value = '';
    }

    // --- MODIFIED: Clear Data for the current user ---
    function clearCurrentUserData() {
        if (confirm(translations[currentLang].confirmClearAll)) {
            localStorage.removeItem(`accountingData_${loggedInUser}`);
            location.reload();
        }
    }

    // --- UNIVERSAL EVENT HANDLERS ---
    function handleEdit(type, id) {
        if (type === 'customer') {
            const cust = customersDB.find(c => c.id === id);
            if (!cust) return;
            editingCustomerId = id;
            $('custCode').value = cust.id; $('custCode').disabled = true;
            $('custName').value = cust.name; $('custTaxNumber').value = cust.taxNumber;
            $('custCrNumber').value = cust.crNumber; $('custNationalId').value = cust.nationalId; $('custPhone').value = cust.phone;
            const addr = cust.address || {};
            $('custCity').value = addr.city; $('custDistrict').value = addr.district; $('custStreet').value = addr.street;
            $('custPostalCode').value = addr.postalCode; $('custBuildingNumber').value = addr.buildingNumber; $('custAdditionalNumber').value = addr.additionalNumber;
            updateMainActionButtonsText();
            document.querySelector('.tab-btn[data-tab="customersTab"]').click();
            document.querySelector('.sub-tab-btn[data-tab="createCustomer"]').click();
        } else if (type === 'item') {
            const item = itemsDB[id];
            if (!item) return;
            editingItemId = id;
            $('itemName').value = item.name; $('itemPrice').value = item.price;
            updateMainActionButtonsText();
            document.querySelector('.tab-btn[data-tab="itemsTab"]').click();
            document.querySelector('.sub-tab-btn[data-tab="createItem"]').click();
        } else if (type === 'invoice') {
            const inv = invoicesDB.find(i => i.invoiceNumber === id);
            if (!inv) return;
            editingInvoiceId = id;
            $('invoiceNumber').value = inv.invoiceNumber; $('invoiceDate').value = toLocalDateTime(new Date(inv.invoiceDate));
            $('customerName').value = inv.customerName;
            handleCustomerSelection({target: $('customerName')}, 'customerBalanceDisplay');
            $('itemsBody').innerHTML = '';
            inv.items.forEach(item => addItem(item.description, item.quantity, item.price));
            updateMainActionButtonsText();
            document.querySelector('.tab-btn[data-tab="invoiceTab"]').click();
            document.querySelector('.sub-tab-btn[data-tab="createInvoice"]').click();
        } else if (type === 'receipt') {
            const rec = receiptsDB.find(r => r.receiptNumber === id);
            if (!rec) return;
            editingReceiptId = id;
            $('receiptNumber').value = rec.receiptNumber; $('receiptDate').value = toLocalDateTime(new Date(rec.date));
            $('receiptCustomerName').value = rec.customerName;
            $('amountReceived').value = rec.amount; $('paymentMethod').value = rec.paymentMethod; $('receiptDescription').value = rec.description;
            handleCustomerSelection({target: $('receiptCustomerName')}, 'receiptCustomerBalanceDisplay');
            updateMainActionButtonsText();
            document.querySelector('.tab-btn[data-tab="receiptTab"]').click();
            document.querySelector('.sub-tab-btn[data-tab="createReceipt"]').click();
        }
    }
    function handleDelete(type, id) {
        if (!confirm(translations[currentLang].confirmDelete)) return;
        if (type === 'customer') {
            const balance = calculateCustomerBalance(id);
            if (parseFloat(balance) !== 0 && !confirm("This customer has a balance. Are you sure?")) return;
            const index = customersDB.findIndex(c => c.id === id);
            if (index > -1) customersDB.splice(index, 1);
        } else if (type === 'item') {
            itemsDB.splice(id, 1);
        } else if (type === 'invoice') {
            const index = invoicesDB.findIndex(i => i.invoiceNumber === id);
            if (index > -1) invoicesDB.splice(index, 1);
        } else if (type === 'receipt') {
            const index = receiptsDB.findIndex(r => r.receiptNumber === id);
            if (index > -1) receiptsDB.splice(index, 1);
        }
        renderAllLogs();
        saveAllDataToLocalStorage();
    }
    function handlePrint(type, id) {
        if (type === 'invoice') {
            const inv = invoicesDB.find(i => i.invoiceNumber === id);
            if (inv) { generateInvoicePreview(inv); document.body.className = 'printing-invoice'; window.print(); }
        } else if (type === 'receipt') {
            const rec = receiptsDB.find(r => r.receiptNumber === id);
            if (rec) { generateReceiptPreview(rec); document.body.className = 'printing-receipt'; window.print(); }
        }
    }
    
    // --- Initialisation ---
    function initializeApp() {
        // Load data first
        loadAllDataFromLocalStorage();

        // --- NEW: Setup welcome message and logout ---
        $('welcomeUser').innerText = `مرحباً، ${loggedInUser}`;
        $('logoutBtn').addEventListener('click', () => {
            sessionStorage.removeItem('loggedInUser');
            window.location.href = 'login.html';
        });

        // Event Listeners for main actions
        $('langToggleBtn').addEventListener('click', () => setLanguage(currentLang === 'ar' ? 'en' : 'ar'));
        $('saveSettingsBtn').addEventListener('click', saveSettings);
        $('exportAllBtn').addEventListener('click', exportAllData);
        $('importAllFile').addEventListener('change', importAllData);
        $('clearAllDataBtn').addEventListener('click', clearCurrentUserData);

        $('saveCustomerBtn').addEventListener('click', saveCustomer);
        $('clearCustomerFormBtn').addEventListener('click', clearCustomerForm);
        $('saveItemBtn').addEventListener('click', saveItem);
        $('clearItemFormBtn').addEventListener('click', clearItemForm);
        $('newInvoiceBtn').addEventListener('click', clearInvoiceForm);
        $('generateBtn').addEventListener('click', saveInvoice);
        $('addItemBtn').addEventListener('click', () => addItem());
        $('newReceiptBtn').addEventListener('click', clearReceiptForm);
        $('saveReceiptBtn').addEventListener('click', saveReceipt);
        $('printInvoiceBtn').addEventListener('click', () => {
            recalcAll();
            const customerName = $("customerName").value;
            const selectedOption = Array.from($('customersDatalist').options).find(opt => opt.value === customerName);
            if (!selectedOption) { alert("Please select a customer to print."); return; }
            const formData = {
                invoiceNumber: $("invoiceNumber").value.trim() || `INV-${Date.now()}`, invoiceDate: new Date($('invoiceDate').value).toISOString(), customerCode: selectedOption.dataset.code, customerName,
                subTotal: parseFloat($("subTotal").innerText).toFixed(2), vatTotal: parseFloat($("vatTotal").innerText).toFixed(2), grandTotal: parseFloat($("grandTotal").innerText).toFixed(2),
                items: Array.from($('itemsBody').querySelectorAll('tr')).map(r => ({ description: r.querySelector('.txt-desc').value, quantity: r.querySelector('.txt-qty').value, price: r.querySelector('.txt-price').value, total: r.querySelector('.cell-line-total').innerText }))
            };
            generateInvoicePreview(formData);
            document.body.className = 'printing-invoice';
            window.print();
        });
        $('printReceiptBtn').addEventListener('click', () => {
            const customerName = $("receiptCustomerName").value;
            const selectedOption = Array.from($('customersDatalist').options).find(opt => opt.value === customerName);
            if (!selectedOption) { alert("Please select a customer to print."); return; }
            const receiptData = {
                receiptNumber: $('receiptNumber').value.trim() || `REC-${Date.now()}`, date: new Date($('receiptDate').value).toISOString(), customerCode: selectedOption.dataset.code, customerName,
                amount: parseFloat($('amountReceived').value) || 0, paymentMethod: $('paymentMethod').value, description: $('receiptDescription').value,
            };
            generateReceiptPreview(receiptData);
            document.body.className = 'printing-receipt';
            window.print();
        });

        // Event listener for dynamic content in tables
        document.body.addEventListener('click', function(e){
            const target = e.target;
            const id = target.dataset.id;
            const type = target.dataset.type;
            if (target.classList.contains('edit-btn') || target.classList.contains('delete-btn') || target.classList.contains('print-btn') || target.classList.contains('statement-btn')) {
                if (!id && id !== 0 || !type) return;
                if (target.classList.contains('edit-btn')) handleEdit(type, id); 
                else if (target.classList.contains('delete-btn')) handleDelete(type, id); 
                else if (target.classList.contains('print-btn')) handlePrint(type, id); 
                else if (target.classList.contains('statement-btn')) {
                    generateStatementPreview(id);
                    document.body.className = 'printing-statement';
                    window.print();
                }
            }
        });
        
        // Customer selection listeners
        $('customerName').addEventListener('input', e => handleCustomerSelection(e, 'customerBalanceDisplay'));
        $('receiptCustomerName').addEventListener('input', e => handleCustomerSelection(e, 'receiptCustomerBalanceDisplay'));
        
        // Default to log view on main tab click
        const mainTabs = [
            { tab: 'invoiceTab', log: 'invoiceLog' },
            { tab: 'receiptTab', log: 'receiptLog' },
            { tab: 'itemsTab', log: 'itemLog' },
            { tab: 'customersTab', log: 'customerLog' }
        ];
        mainTabs.forEach(item => {
            const tabButton = document.querySelector(`.tab-btn[data-tab="${item.tab}"]`);
            if (tabButton) {
                tabButton.addEventListener('click', () => {
                    document.querySelector(`.sub-tab-btn[data-tab="${item.log}"]`)?.click();
                });
            }
        });

        // Final setup calls
        setupTabSwitching();
        loadSettingsForm();
        renderAllLogs();
        clearInvoiceForm();
        clearReceiptForm();
        clearCustomerForm();
        clearItemForm();
        setLanguage('ar');
        
        document.body.addEventListener('afterprint', () => { document.body.className = ''; });
    }
    
    initializeApp();
});
</script>
</body>
</html>